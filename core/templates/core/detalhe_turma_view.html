{% extends 'core/base.html' %}

{% block title %}Detalhes da Turma - SIGE ERP{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4 mb-5">
    <!-- ERP Header Section -->
    <div class="row align-items-center mb-4">
        <div class="col-md-8">
            <h1 class="h3 fw-bold text-dark mb-1" style="letter-spacing: -0.5px;">{{ turma.nome }}</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{% url 'painel_principal' %}">Painel</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'atribuicao_turmas' %}">Turmas</a></li>
                    <li class="breadcrumb-item active">{{ turma.nome }}</li>
                </ol>
            </nav>
        </div>
        <div class="col-md-4 text-md-end mt-3 mt-md-0">
            <div class="d-flex gap-2 justify-content-md-end">
                <a href="{% url 'atribuicao_turmas' %}" class="btn btn-white border rounded-3 px-3 shadow-sm">
                    <i class="bi bi-arrow-left me-2"></i>Voltar à Lista
                </a>
                <button class="btn btn-white border rounded-3 px-3 shadow-sm" onclick="window.print()">
                    <i class="bi bi-printer me-2"></i>Imprimir
                </button>
                <button class="btn btn-primary rounded-3 px-4 shadow-sm fw-bold">
                    <i class="bi bi-gear me-2"></i>Configurações
                </button>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Stats & Info -->
        <div class="col-lg-3">
            <!-- Basic Info Card -->
            <div class="card border-0 shadow-sm rounded-4 mb-4 overflow-hidden">
                <div class="card-header bg-primary bg-opacity-10 py-3 border-0">
                    <h6 class="fw-bold mb-0 text-primary"><i class="bi bi-info-circle me-2"></i>Informações Gerais</h6>
                </div>
                <div class="card-body p-4">
                    <div class="mb-4">
                        <label class="text-muted small fw-bold text-uppercase d-block mb-1">Curso</label>
                        <span class="text-dark fw-bold">{{ turma.curso.nome }}</span>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 border border-white shadow-sm">
                                <label class="text-muted small fw-bold text-uppercase d-block mb-1">Turno</label>
                                <span class="text-dark fw-bold small">{{ turma.get_turno_display }}</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 border border-white shadow-sm">
                                <label class="text-muted small fw-bold text-uppercase d-block mb-1">Ano Acad.</label>
                                <span class="text-dark fw-bold small">{{ turma.ano_academico }}º Ano</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 border border-white shadow-sm">
                                <label class="text-muted small fw-bold text-uppercase d-block mb-1">Período</label>
                                <span class="text-dark fw-bold small">{{ turma.periodo_curricular }}º Per.</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 bg-light rounded-4 border border-white shadow-sm">
                                <label class="text-muted small fw-bold text-uppercase d-block mb-1">Status</label>
                                <span class="badge {% if turma.ativa %}bg-success{% else %}bg-danger{% endif %} bg-opacity-10 {% if turma.ativa %}text-success{% else %}text-danger{% endif %} border rounded-pill px-2 py-1 w-100" style="font-size: 0.65rem;">
                                    {% if turma.ativa %}ATIVA{% else %}INATIVA{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>

                    <hr class="my-4 opacity-10">
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-light border w-100 text-start d-flex align-items-center justify-content-between p-3 rounded-3 shadow-none">
                            <span><i class="bi bi-people me-2 text-primary"></i>Lista de Alunos</span>
                            <span class="badge bg-primary rounded-pill">{{ turma.inscricao_set.count|default:0 }}</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Curricular Structure -->
        <div class="col-lg-9">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden bg-white">
                <div class="card-header bg-white py-3 border-bottom d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0 text-dark">Estrutura Curricular e Atribuições</h5>
                    <span class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 rounded-pill px-3">
                        {{ disciplinas_turma|length }} Disciplinas
                    </span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 text-muted small fw-bold text-uppercase">Disciplina</th>
                                <th class="text-muted small fw-bold text-uppercase">Corpo Docente</th>
                                <th class="text-muted small fw-bold text-uppercase">Localização</th>
                                <th class="text-end pe-4 text-muted small fw-bold text-uppercase">Gestão</th>
                            </tr>
                        </thead>
                        <tbody class="border-top-0">
                            {% for td in disciplinas_turma %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-light rounded-circle p-2 me-3 text-primary">
                                            <i class="bi bi-journal-bookmark fs-5"></i>
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark mb-0">{{ td.disciplina.nome }}</div>
                                            <div class="text-muted small">{{ td.disciplina.codigo }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if td.professor %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle me-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <span class="text-primary fw-bold" style="font-size: 0.8rem;">{{ td.professor.username|slice:":1"|upper }}</span>
                                            </div>
                                            <span class="fw-medium text-dark">{{ td.professor.get_full_name|default:td.professor.username }}</span>
                                        </div>
                                    {% else %}
                                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger border-opacity-10 rounded-pill px-3">
                                            <i class="bi bi-person-x me-1"></i>Pendente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if td.sala %}
                                        <div class="d-flex align-items-center text-dark">
                                            <i class="bi bi-geo-alt me-2 text-primary opacity-50"></i>
                                            <span>{{ td.sala.nome }}</span>
                                        </div>
                                    {% else %}
                                        <span class="text-muted smaller">Não definida</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-light border rounded-3 px-3" data-bs-toggle="modal" data-bs-target="#modalEdit{{ td.id }}">
                                        <i class="bi bi-pencil me-1"></i> Atribuir
                                    </button>

                                    <!-- Modal Atribuição -->
                                    <div class="modal fade" id="modalEdit{{ td.id }}" tabindex="-1" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered">
                                            <div class="modal-content border-0 shadow-lg rounded-4 overflow-hidden">
                                                <div class="modal-header border-0 bg-primary py-4 px-4">
                                                    <div>
                                                        <h5 class="modal-title fw-bold text-white mb-0">Gestão Académica</h5>
                                                        <p class="text-white text-opacity-75 small mb-0">{{ td.disciplina.nome }}</p>
                                                    </div>
                                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <form method="POST">
                                                    {% csrf_token %}
                                                    <input type="hidden" name="action" value="atualizar_professor">
                                                    <input type="hidden" name="td_id" value="{{ td.id }}">
                                                    <div class="modal-body p-4 bg-white">
                                                        <div class="mb-4 text-start">
                                                            <label class="form-label small fw-bold text-muted text-uppercase mb-2">Professor Responsável</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-person-badge text-primary"></i></span>
                                                                <select name="professor_id" class="form-select bg-light border-start-0 ps-0">
                                                                    <option value="">Selecione o docente...</option>
                                                                    {% for prof in professores %}
                                                                    <option value="{{ prof.id }}" {% if td.professor_id == prof.id %}selected{% endif %}>
                                                                        {{ prof.get_full_name|default:prof.username }}
                                                                    </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>

                                                        <div class="mb-0 text-start">
                                                            <label class="form-label small fw-bold text-muted text-uppercase mb-2">Espaço / Sala</label>
                                                            <div class="input-group">
                                                                <span class="input-group-text bg-light border-end-0"><i class="bi bi-geo-alt text-primary"></i></span>
                                                                <select name="sala_id" class="form-select bg-light border-start-0 ps-0">
                                                                    <option value="">Selecione a sala...</option>
                                                                    {% for sala in salas %}
                                                                    <option value="{{ sala.id }}" {% if td.sala_id == sala.id %}selected{% endif %}>
                                                                        {{ sala.nome }}
                                                                    </option>
                                                                    {% endfor %}
                                                                </select>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer border-0 bg-light p-4">
                                                        <button type="button" class="btn btn-link text-muted text-decoration-none fw-bold me-auto" data-bs-dismiss="modal">CANCELAR</button>
                                                        <button type="submit" class="btn btn-primary rounded-pill px-5 py-2 fw-bold shadow-sm">SALVAR</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-5">
                                    <div class="opacity-25 mb-3">
                                        <i class="bi bi-journal-x" style="font-size: 4rem;"></i>
                                    </div>
                                    <h5 class="text-muted fw-light">Nenhuma disciplina vinculada a esta turma.</h5>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    @media print {
        .navbar-top, footer, .btn, .breadcrumb {
            display: none !important;
        }
        .container-fluid {
            padding: 0 !important;
        }
        .card {
            box-shadow: none !important;
            border: 1px solid #eee !important;
        }
    }
</style>
{% endblock %}
