{% extends 'core/base.html' %}

{% block title %}Calendário Académico - SIGE{% endblock %}

{% block content %}
<div class="container-fluid px-0" style="background-color: #f8fafc; min-height: 100vh;">
    <!-- Top Header Style -->
    <div class="bg-white border-bottom py-4 px-5 mb-5 shadow-sm">
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <a href="{% url 'painel_principal' %}" class="btn btn-light rounded-circle me-4 shadow-sm border d-flex align-items-center justify-content-center" style="width: 45px; height: 45px;">
                    <i class="bi bi-arrow-left fs-5"></i>
                </a>
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb small mb-1 text-muted">
                            <li class="breadcrumb-item">Gestão académica</li>
                            <li class="breadcrumb-item active fw-bold text-primary">Calendário Académico</li>
                        </ol>
                    </nav>
                    <h3 class="mb-0 fw-bold text-dark">Cronograma Académico Estratégico</h3>
                </div>
            </div>
            <div class="d-none d-md-block">
                <div class="d-flex gap-2">
                    {% if user.perfil.nivel_acesso in 'admin,super_admin,secretaria' %}
                    <a href="{% url 'gestao_eventos' %}" class="btn btn-primary px-4 py-2 rounded-pill fw-bold shadow-sm transition-hover">
                        <i class="bi bi-calendar-event me-2"></i> Gerir Cronograma
                    </a>
                    {% endif %}
                    <a href="{% url 'ano_academico_lista' %}" class="btn btn-outline-dark px-4 py-2 rounded-pill fw-bold transition-hover">
                        <i class="bi bi-gear me-2"></i> Ciclos
                    </a>
                    <button class="btn btn-outline-primary px-4 py-2 rounded-pill fw-bold shadow-sm transition-hover" onclick="window.print()">
                        <i class="bi bi-printer me-2"></i> Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid pb-5 px-md-5">
        <div class="row g-4 justify-content-center">
            {% for ano in anos %}
            <div class="col-12">
                <div class="card border-0 shadow-lg h-100" style="border-radius: 24px; background: #fff; overflow: hidden;">
                    <div class="card-header bg-white border-0 pt-5 px-5 d-flex justify-content-between align-items-start flex-wrap gap-4">
                        <div>
                            <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                <h2 class="fw-bold mb-0 text-dark" style="font-size: 3.5rem; letter-spacing: -2px;">Ciclo {{ ano.codigo }}</h2>
                                {% if ano.ano_atual %}
                                <span class="badge bg-primary px-3 py-2 rounded-pill fw-bold" style="font-size: 0.8rem; letter-spacing: 0.5px;">ANO ACTUAL</span>
                                {% endif %}
                            </div>
                            <p class="text-muted mb-0 fs-5"><i class="bi bi-info-circle me-1 text-primary"></i> Governança e Planeamento do Ano Lectivo</p>
                        </div>
                        <div class="text-end flex-grow-1 flex-md-grow-0">
                            {% if ano.inscricoes_abertas %}
                            <div class="d-inline-flex align-items-center bg-success bg-opacity-10 text-success border border-success border-opacity-25 px-4 py-3 rounded-4 shadow-sm w-100 justify-content-center">
                                <span class="position-relative d-flex h-3 w-3 me-3">
                                    <span class="animate-ping position-absolute inline-flex h-full w-full rounded-full bg-success opacity-75"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-success"></span>
                                </span>
                                <span class="fw-bold text-uppercase small" style="letter-spacing: 1px;">Inscrições Abertas</span>
                            </div>
                            {% else %}
                            <div class="d-inline-flex align-items-center bg-danger bg-opacity-10 text-danger border border-danger border-opacity-25 px-4 py-3 rounded-4 shadow-sm w-100 justify-content-center">
                                <i class="bi bi-lock-fill me-3 fs-5"></i>
                                <span class="fw-bold text-uppercase small" style="letter-spacing: 1px;">Inscrições Encerradas</span>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="card-body p-5">
                        <!-- Dashboard de Status ERP -->
                        <div class="row g-4 mb-5">
                            <div class="col-lg-4 col-md-6">
                                <div class="p-4 rounded-4 border bg-light bg-opacity-25 h-100 transition-hover border-2 text-center shadow-sm d-flex flex-column align-items-center justify-content-center py-5">
                                    <label class="text-muted smaller fw-bold text-uppercase d-block mb-3" style="letter-spacing: 2px;">Estado Operacional</label>
                                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 p-3 mb-4" style="width: 80px; height: 80px;">
                                        <i class="bi bi-activity text-primary fs-1"></i>
                                    </div>
                                    <h3 class="fw-bold text-dark mb-0 fs-2">{{ ano.get_estado_display }}</h3>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-6">
                                <div class="p-4 rounded-4 border bg-light bg-opacity-25 h-100 transition-hover border-2 text-center shadow-sm d-flex flex-column align-items-center justify-content-center py-5">
                                    <label class="text-muted smaller fw-bold text-uppercase d-block mb-3" style="letter-spacing: 2px;">Início do Ciclo</label>
                                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 p-3 mb-4" style="width: 80px; height: 80px;">
                                        <i class="bi bi-calendar-check text-success fs-1"></i>
                                    </div>
                                    <h3 class="fw-bold text-dark mb-0 fs-2">{{ ano.data_inicio|date:"d M Y" }}</h3>
                                </div>
                            </div>
                            <div class="col-lg-4 col-md-12">
                                <div class="p-4 rounded-4 border bg-light bg-opacity-25 h-100 transition-hover border-2 text-center shadow-sm d-flex flex-column align-items-center justify-content-center py-5">
                                    <label class="text-muted smaller fw-bold text-uppercase d-block mb-3" style="letter-spacing: 2px;">Encerramento</label>
                                    <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-danger bg-opacity-10 p-3 mb-4" style="width: 80px; height: 80px;">
                                        <i class="bi bi-calendar-x text-danger fs-1"></i>
                                    </div>
                                    <h3 class="fw-bold text-dark mb-0 fs-2">{{ ano.data_fim|date:"d M Y" }}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="row g-5">
                            <!-- Lado Esquerdo: Timeline Profissional -->
                            <div class="col-lg-8">
                                <div class="d-flex align-items-center justify-content-between mb-4 pb-2 border-bottom">
                                    <h4 class="fw-bold mb-0 d-flex align-items-center">
                                        <i class="bi bi-clock-history text-primary me-3 fs-3"></i> Marcos Temporais
                                    </h4>
                                    <span class="badge bg-light text-dark border rounded-pill px-4 py-2 fs-6">{{ ano.eventos.count }} Acções</span>
                                </div>
                                
                                <div class="timeline-erp pt-2 ps-2">
                                    {% for evento in ano.eventos.all %}
                                    <div class="timeline-item-erp mb-4 {% if evento.esta_ocorrendo %}active{% endif %}">
                                        <div class="d-flex">
                                            <div class="timeline-marker me-4">
                                                <div class="marker-line"></div>
                                                <div class="marker-dot shadow-sm"></div>
                                            </div>
                                                    <div class="timeline-content-erp flex-fill p-4 border rounded-4 bg-white shadow-sm transition-hover {% if evento.esta_ocorrendo %}border-primary border-2{% endif %}">
                                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                                            <h6 class="fw-bold text-dark mb-0 fs-5">
                                                                {{ evento.descricao }}
                                                            </h6>
                                                            <div class="d-flex align-items-center gap-2">
                                                                <span class="badge {% if evento.tipo_evento == 'INSCRICAO' %}bg-info{% elif evento.tipo_evento == 'MATRICULA' %}bg-success{% elif evento.tipo_evento == 'EXAME_ACESSO' or evento.tipo_evento == 'PROVAS_ADMISSAO' %}bg-warning{% elif evento.tipo_evento == 'EXAME' or evento.tipo_evento == 'RECURSO' %}bg-danger{% else %}bg-secondary{% endif %} rounded-pill px-3 py-2">
                                                                    {{ evento.get_tipo_evento_display }}
                                                                </span>
                                                            </div>
                                                        </div>
                                                <div class="d-flex align-items-center text-muted fs-6">
                                                    <i class="bi bi-calendar3 me-2 text-primary"></i>
                                                    <span class="fw-medium text-dark">{{ evento.data_inicio|date:"d/m/Y" }}</span>
                                                    <i class="bi bi-arrow-right mx-2 opacity-50"></i>
                                                    <span class="fw-medium text-dark">{{ evento.data_fim|date:"d/m/Y" }}</span>
                                                    
                                                    {% if evento.esta_ocorrendo %}
                                                    <div class="ms-auto d-flex align-items-center text-primary fw-bold">
                                                        <span class="pulse-dot me-2"></span>
                                                        <small class="text-uppercase" style="letter-spacing: 1px;">Em Curso</small>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="text-center py-5 bg-light rounded-5 border-dashed">
                                        <i class="bi bi-calendar-event text-muted display-4 mb-3 d-block"></i>
                                        <p class="text-muted fw-bold">Sem marcos temporais definidos.</p>
                                        <a href="/admin/core/eventocalendario/add/" class="btn btn-sm btn-primary rounded-pill px-4 mt-2">Configurar Agora</a>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Lado Direito: Regras de Negócio e Facturação -->
                            <div class="col-lg-4 mb-5 pb-5">
                                {% if ano.cobrar_propinas %}
                                <div class="d-flex align-items-center mb-4 pb-2 border-bottom">
                                    <h4 class="fw-bold mb-0 d-flex align-items-center text-success">
                                        <i class="bi bi-shield-check me-3 fs-3"></i> Regras de Facturação
                                    </h4>
                                </div>

                                <div class="card border-0 bg-dark text-white rounded-4 p-3 mb-2 shadow-lg position-relative" style="font-size: 0.9rem;">
                                    <div class="position-absolute top-0 end-0 p-2 opacity-10">
                                        <span style="font-size: 4rem; font-weight: 800; font-family: 'Inter', sans-serif;">Kz</span>
                                    </div>
                                    
                                    <div class="position-relative z-1">
                                        {% with dia_hoje=hoje|date:"j"|add:"0" %}
                                        <div class="mb-3">
                                            {% if dia_hoje <= ano.dia_pagamento_limite %}
                                                <div class="bg-success bg-opacity-25 border border-success border-opacity-50 p-3 rounded-3 mb-0 text-center">
                                                    <i class="bi bi-check-circle-fill mb-1 d-block fs-4 text-success"></i>
                                                    <p class="small fw-bold mb-1 text-uppercase">Janela de Pagamento Regular</p>
                                                    <div class="progress mb-2" style="height: 4px; background: rgba(255,255,255,0.1);">
                                                        <div class="progress-bar bg-success" role="progressbar" style="width: {% widthratio dia_hoje ano.dia_pagamento_limite 100 %}%"></div>
                                                    </div>
                                                    <small class="opacity-75" style="font-size: 0.75rem;">Status: Pagamentos sem acréscimo de multas até o dia {{ ano.dia_pagamento_limite }}.</small>
                                                </div>
                                            {% elif dia_hoje <= ano.dia_limite_multa %}
                                                <div class="bg-warning bg-opacity-25 border border-warning border-opacity-50 p-3 rounded-3 mb-0 text-center text-warning">
                                                    <i class="bi bi-exclamation-triangle-fill mb-1 d-block fs-4"></i>
                                                    <p class="small fw-bold mb-1 text-uppercase text-white">Fase de Mora (Com Multa)</p>
                                                    <div class="progress mb-2" style="height: 4px; background: rgba(255,255,255,0.1);">
                                                        <div class="progress-bar bg-warning" role="progressbar" style="width: 100%"></div>
                                                    </div>
                                                    <small class="text-white opacity-75" style="font-size: 0.75rem;">Atenção: Aplicação de multa de {{ ano.percentagem_multa_inicial }}% sobre o valor base.</small>
                                                </div>
                                            {% else %}
                                                <div class="bg-danger bg-opacity-25 border border-danger border-opacity-50 p-3 rounded-3 mb-0 text-center text-white">
                                                    <i class="bi bi-slash-circle-fill mb-1 d-block fs-4"></i>
                                                    <p class="small fw-bold mb-1 text-uppercase">Ciclo de Bloqueio Activo</p>
                                                    <small class="opacity-75" style="font-size: 0.75rem;">Sistema: Estudante impedido de realizar operações académicas por falta de pagamento.</small>
                                                </div>
                                            {% endif %}
                                        </div>
                                        {% endwith %}

                                        <div class="space-y-2">
                                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom border-secondary border-opacity-50">
                                                <span class="opacity-75 smaller">Pagamento Regular até</span>
                                                <span class="fw-bold">Dia {{ ano.dia_pagamento_limite }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom border-secondary border-opacity-50">
                                                <span class="opacity-75 smaller">Início das Multas</span>
                                                <span class="fw-bold text-warning">Dia {{ ano.dia_inicio_multa }}</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center py-1 border-bottom border-secondary border-opacity-50">
                                                <span class="opacity-75 smaller">Taxa de Mora (Multa)</span>
                                                <span class="fw-bold text-danger">{{ ano.percentagem_multa_inicial }}%</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center py-1">
                                                <span class="opacity-75 smaller">Bloqueio do Sistema</span>
                                                <span class="fw-bold text-danger">Dia {{ ano.dia_bloqueio_estudante }}</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-light border-0 px-5 py-4 d-flex justify-content-between align-items-center mt-5" style="border-bottom-left-radius: 24px; border-bottom-right-radius: 24px;">
                        <span class="text-muted small"><i class="bi bi-shield-lock me-1"></i> Auditado pelo Sistema em: {{ ano.data_criacao|date:"d/m/Y H:i" }}</span>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-light border px-4 rounded-pill fw-bold">Histórico</button>
                            <button class="btn btn-sm btn-primary px-4 rounded-pill fw-bold">Verificar Integridade</button>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12 text-center py-5 mt-5">
                <div class="display-1 text-muted opacity-10 mb-4">
                    <i class="bi bi-calendar-x"></i>
                </div>
                <h3 class="fw-bold text-muted">Sem Ciclo Académico Activo</h3>
                <p class="text-muted fs-5">Configure o ano académico actual para activar o cronograma.</p>
                <a href="{% url 'ano_academico_create' %}" class="btn btn-primary px-5 py-3 rounded-pill fw-bold shadow mt-4">Criar Novo Ciclo</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    .transition-hover {
        transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
    }
    .transition-hover:hover {
        transform: translateY(-8px);
        box-shadow: 0 1.5rem 4rem rgba(0,0,0,.1) !important;
    }
    .timeline-erp {
        position: relative;
    }
    .timeline-marker {
        position: relative;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .marker-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 3px;
        background: #f1f5f9;
        border-radius: 3px;
    }
    .timeline-item-erp:last-child .marker-line {
        bottom: auto;
        height: 25px;
    }
    .marker-dot {
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: #fff;
        border: 5px solid #e2e8f0;
        z-index: 1;
        margin-top: 15px;
        transition: all 0.3s ease;
    }
    .timeline-item-erp.active .marker-dot {
        border-color: #3b82f6;
        background: #3b82f6;
        box-shadow: 0 0 0 6px rgba(59, 130, 246, 0.15);
    }
    .timeline-item-erp.active .marker-line {
        background: #3b82f6;
        opacity: 0.25;
    }
    .pulse-dot {
        width: 10px;
        height: 10px;
        background-color: #3b82f6;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
    }
    .smaller {
        font-size: 0.8rem;
    }
    .border-dashed {
        border: 2.5px dashed #e2e8f0 !important;
    }
    .space-y-2 > * + * {
        margin-top: 0.5rem;
    }
    .space-y-4 > * + * {
        margin-top: 1rem;
    }
    @media print {
        .btn, .card-footer, .breadcrumb, .alert, .badge { display: none !important; }
        .card { border: none !important; box-shadow: none !important; margin: 0 !important; }
        body { background: white !important; }
        .container-fluid { padding: 0 !important; }
        .card-header { padding-top: 2rem !important; }
    }
    .hover-primary:hover {
        color: #3b82f6 !important;
        text-decoration: underline !important;
    }
</style>
{% endblock %}