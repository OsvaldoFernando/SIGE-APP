{% extends 'core/base.html' %}

{% block title %}Inscrição - {{ curso.nome }}{% endblock %}

{% block content %}
<div class="container my-5 pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 mb-5">
            <!-- Formulário com Barra de Progresso -->
            <div class="card shadow">
                <div class="card-header bg-custom text-white py-2">
                    <h5 class="mb-1">Formulário de Inscrição - {{ curso.nome }}</h5>
                </div>
                
                <!-- Barra de Progresso -->
                <div class="py-3 px-2" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                    <div class="progress-wizard">
                        <div class="wizard-step active" data-step="1">
                            <div class="wizard-icon"><i class="bi bi-person-badge"></i></div>
                            <div class="wizard-label">Identificação</div>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="wizard-icon"><i class="bi bi-people-fill"></i></div>
                            <div class="wizard-label">Responsáveis</div>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <div class="wizard-icon"><i class="bi bi-telephone"></i></div>
                            <div class="wizard-label">Contacto</div>
                        </div>
                        <div class="wizard-step" data-step="4">
                            <div class="wizard-icon"><i class="bi bi-gear"></i></div>
                            <div class="wizard-label">Configurações</div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <form method="post" id="inscricaoForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Etapa 1: Identificação -->
                        <div class="form-step active" data-step="1">
                            <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>Identificação</h5>
                            <div class="row">
                                <div class="col-md-3 mb-3 text-center">
                                    <div id="photo_preview" class="border rounded mb-2 d-flex align-items-center justify-content-center position-relative" style="width: 150px; height: 180px; margin: 0 auto; background-color: #f8f9fa; overflow: hidden;">
                                        <i class="bi bi-person" id="placeholder_icon" style="font-size: 4rem; color: #dee2e6;"></i>
                                        <video id="webcam_video" style="display: none; width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                        <canvas id="photo_canvas" style="display: none;"></canvas>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <label class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-upload me-1"></i> Do PC
                                            <input type="file" name="foto" id="id_foto" hidden accept="image/*">
                                        </label>
                                        <button type="button" id="btn_webcam" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-camera me-1"></i> Webcam
                                        </button>
                                        <button type="button" id="btn_capture" class="btn btn-sm btn-success d-none">
                                            <i class="bi bi-camera-fill me-1"></i> Capturar
                                        </button>
                                        <button type="button" id="btn_cancel_webcam" class="btn btn-sm btn-danger d-none">
                                            <i class="bi bi-x-circle me-1"></i> Cancelar
                                        </button>
                                    </div>
                                    <input type="hidden" name="foto_base64" id="id_foto_base64">
                                </div>
                                <div class="col-md-9">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Primeiro Nome *</label>
                                            <input type="text" name="primeiro_nome" class="form-control" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Nomes do Meio</label>
                                            <input type="text" name="nomes_meio" class="form-control">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Apelido *</label>
                                            <input type="text" name="apelido" class="form-control" required>
                                        </div>
                                        
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Data de Nascimento *</label>
                                            <input type="date" name="data_nascimento" id="data_nascimento" class="form-control" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Sexo *</label>
                                            <select name="sexo" class="form-select" required>
                                                <option value="">Selecione...</option>
                                                <option value="M">Masculino</option>
                                                <option value="F">Feminino</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Estado Civil</label>
                                            <select name="estado_civil" class="form-select">
                                                <option value="S" selected>Solteiro(a)</option>
                                                <option value="C">Casado(a)</option>
                                                <option value="D">Divorciado(a)</option>
                                                <option value="V">Viúvo(a)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Documentos -->
                                <div class="col-md-12 mb-4">
                                    <h6 class="text-primary border-bottom pb-2 mt-3"><i class="bi bi-file-earmark-arrow-up me-2"></i>Documentação Acadêmica</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Cópia do BI</label>
                                            <input type="file" name="arquivo_bi" class="form-control" accept="image/*,.pdf">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Certificado de Habilitações</label>
                                            <input type="file" name="arquivo_certificado" class="form-control" accept="image/*,.pdf">
                                        </div>
                                    </div>
                                </div>

                                <!-- Identificação e BI -->
                                <div class="col-md-12 mb-4">
                                    <h6 class="text-primary border-bottom pb-2"><i class="bi bi-card-text me-2"></i>Bilhete de Identidade e Origem</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Número do BI *</label>
                                            <input type="text" name="bilhete_identidade" id="bilhete_identidade" class="form-control check-exists" data-campo="bilhete_identidade" required maxlength="14" placeholder="000000000AB000">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Data de Validade *</label>
                                            <input type="date" name="data_validade_bi" id="data_validade_bi" class="form-control" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label class="form-label">Nacionalidade *</label>
                                            <select name="nacionalidade" id="id_nacionalidade" class="form-select" required>
                                                <option value="Angolana" selected>Angolana</option>
                                                <option value="Outra">Outra</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Seção Angola -->
                                        <div class="col-md-4 mb-3" id="div_provincia_select">
                                            <label class="form-label">Província de Nascimento *</label>
                                            <select id="provincia_nascimento_select" name="provincia_nascimento_angola" class="form-select">
                                                <option value="">Selecione a província...</option>
                                                <option value="Bengo">Bengo</option>
                                                <option value="Benguela">Benguela</option>
                                                <option value="Bié">Bié</option>
                                                <option value="Cabinda">Cabinda</option>
                                                <option value="Cuando Cubango">Cuando Cubango</option>
                                                <option value="Cuanza Norte">Cuanza Norte</option>
                                                <option value="Cuanza Sul">Cuanza Sul</option>
                                                <option value="Cunene">Cunene</option>
                                                <option value="Huambo">Huambo</option>
                                                <option value="Huíla">Huíla</option>
                                                <option value="Luanda" selected>Luanda</option>
                                                <option value="Lunda Norte">Lunda Norte</option>
                                                <option value="Lunda Sul">Lunda Sul</option>
                                                <option value="Malanje">Malanje</option>
                                                <option value="Moxico">Moxico</option>
                                                <option value="Namibe">Namibe</option>
                                                <option value="Uíge">Uíge</option>
                                                <option value="Zaire">Zaire</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4 mb-3" id="div_municipio_select">
                                            <label class="form-label">Município de Nascimento *</label>
                                            <select id="municipio_nascimento_select" name="municipio_nascimento_angola" class="form-select">
                                                <option value="">Selecione o município...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Seção Estrangeiro (Outra Nacionalidade) -->
                                        <div class="col-md-4 mb-3 d-none" id="div_provincia_manual">
                                            <label class="form-label">Província / Estado</label>
                                            <input type="text" name="provincia_nascimento_manual" id="provincia_nascimento_manual" class="form-control" placeholder="Digite a província">
                                        </div>
                                        <div class="col-md-4 mb-3 d-none" id="div_municipio_manual">
                                            <label class="form-label">Município / Cidade</label>
                                            <input type="text" name="local_nascimento_manual" id="municipio_nascimento_manual" class="form-control" placeholder="Digite o município">
                                        </div>
                                        
                                        <!-- Campos reais que serão enviados ao backend -->
                                        <input type="hidden" name="local_nascimento" id="id_local_nascimento_final">
                                        <input type="hidden" name="provincia_nascimento" id="id_provincia_nascimento_final">
                                    </div>
                                </div>

                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Endereço Residencial Completo *</label>
                                    <textarea name="endereco" class="form-control" rows="2" required placeholder="Rua, Bairro, Município, Província"></textarea>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone Secundário</label>
                                    <input type="tel" name="telefone_secundario" class="form-control" placeholder="+244...">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" name="email" class="form-control" required>
                                    <div class="invalid-feedback">O email é obrigatório para notificações do sistema.</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Etapa 2: Responsáveis -->
                        <div class="form-step" data-step="2">
                            <h5 class="mb-3"><i class="bi bi-people-fill me-2"></i>Responsáveis</h5>
                            <div class="row">
                                <div class="col-md-12 mb-4">
                                    <h6 class="text-primary border-bottom pb-2">Responsável Legal / Financeiro</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nome Completo</label>
                                            <input type="text" name="responsavel_legal_nome" class="form-control">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Grau / Vínculo</label>
                                            <input type="text" name="responsavel_legal_vinculo" class="form-control" placeholder="Ex: Pai, Mãe">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Telefone</label>
                                            <input type="tel" name="responsavel_legal_telefone" class="form-control">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <h6 class="text-primary border-bottom pb-2">Responsável Pedagógico</h6>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nome Completo</label>
                                            <input type="text" name="responsavel_pedagogico_nome" class="form-control">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Grau / Vínculo</label>
                                            <input type="text" name="responsavel_pedagogico_vinculo" class="form-control" placeholder="Ex: Tutor, Tio">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label class="form-label">Telefone</label>
                                            <input type="tel" name="responsavel_pedagogico_telefone" class="form-control">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 3: Contacto -->
                        <div class="form-step" data-step="3">
                            <h5 class="mb-3"><i class="bi bi-telephone me-2"></i>Contacto</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone Principal *</label>
                                    <input type="tel" name="telefone" class="form-control" required>
                                    <div class="invalid-feedback">O telefone principal é obrigatório.</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Telefone Alternativo</label>
                                    <input type="tel" name="telefone_alternativo" class="form-control">
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Email de Recuperação (Opcional)</label>
                                    <input type="email" name="email_recuperacao" class="form-control">
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 4: Configurações -->
                        <div class="form-step" data-step="4">
                            <h5 class="mb-3"><i class="bi bi-gear me-2"></i>Configurações</h5>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" name="receber_emails_sistema" id="id_receber_emails_sistema" checked>
                                        <label class="form-check-label" for="id_receber_emails_sistema">Deseja receber emails do sistema?</label>
                                    </div>
                                    <small class="text-muted">Ao ativar esta opção, o estudante receberá notificações automáticas sobre o estado da sua inscrição e outras informações relevantes por email.</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botões de Navegação -->
                        <hr class="my-4">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="btn_prev">
                                <i class="bi bi-arrow-left me-2"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-custom" id="btn_next">
                                Próximo<i class="bi bi-arrow-right ms-2"></i>
                            </button>
                            <button type="submit" class="btn btn-success d-none" id="btn_submit">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Inscrição
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-custom { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); }
    .progress-wizard { display: flex; justify-content: space-between; position: relative; }
    .progress-wizard::before { content: ''; position: absolute; top: 25px; left: 12.5%; right: 12.5%; height: 3px; background: #e0e0e0; z-index: 0; }
    .wizard-step { flex: 1; text-align: center; position: relative; z-index: 1; }
    .wizard-icon { width: 50px; height: 50px; border-radius: 50%; background: #e0e0e0; color: #666; display: inline-flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-bottom: 8px; transition: all 0.3s; }
    .wizard-step.active .wizard-icon { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); color: white; transform: scale(1.1); }
    .wizard-step.completed .wizard-icon { background: #059669; color: white; }
    .wizard-label { font-size: 0.9rem; color: #666; font-weight: 500; }
    .wizard-step.active .wizard-label { color: #1e3a8a; font-weight: 600; }
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .btn-custom { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); border: none; color: white; }
    .btn-custom:hover { background: linear-gradient(135deg, #1e40af 0%, #10b981 100%); color: white; }
</style>

<script>
const municipiosPorProvincia = {
    'Bengo': ['Ambriz', 'Bula Atumba', 'Dande', 'Dembos', 'Nambuangongo', 'Pango Aluquém'],
    'Benguela': ['Balombo', 'Baía Farta', 'Benguela', 'Bocoio', 'Caimbambo', 'Catumbela', 'Chongorói', 'Ganda', 'Lobito'],
    'Bié': ['Andulo', 'Camacupa', 'Catabola', 'Chinguar', 'Chitembo', 'Cuemba', 'Cunhinga', 'Cuíto', 'Nharea'],
    'Cabinda': ['Belize', 'Buco-Zau', 'Cabinda', 'Cacongo'],
    'Cuando Cubango': ['Calai', 'Cuangar', 'Cuchi', 'Cuito Cuanavale', 'Dirico', 'Mavinga', 'Menongue', 'Nancova', 'Rivungo'],
    'Cuanza Norte': ['Ambaca', 'Banguela', 'Bolongongo', 'Cambambe', 'Cazengo', 'Golungo Alto', 'Gonguembo', 'Lucala', 'Quiculungo', 'Samba Caju'],
    'Cuanza Sul': ['Amboim', 'Cassongue', 'Cela', 'Conda', 'Ebo', 'Libolo', 'Mussende', 'Porto Amboim', 'Quibala', 'Quilenda', 'Seles', 'Sumbe'],
    'Cunene': ['Cahama', 'Cuanhama', 'Curoca', 'Cuvelai', 'Namacunde', 'Ombadja'],
    'Huambo': ['Bailundo', 'Caála', 'Catchiungo', 'Chicala-Cholohanga', 'Chinjenje', 'Ecunha', 'Huambo', 'Londuimbali', 'Longonjo', 'Mungo', 'Ucuma'],
    'Huíla': ['Caconda', 'Cacula', 'Caluquembe', 'Chiange', 'Chibia', 'Chicomba', 'Chipindo', 'Cuvango', 'Humpata', 'Jamba', 'Lubango', 'Matala', 'Quilengues', 'Quipungo'],
    'Luanda': ['Belas', 'Cacuaco', 'Cazenga', 'Icolo e Bengo', 'Luanda', 'Quiçama', 'Kilamba Kiaxi', 'Talatona', 'Viana'],
    'Lunda Norte': ['Cambulo', 'Capenda-Camulemba', 'Caungula', 'Chitato', 'Cuilo', 'Cuango', 'Lubalo', 'Lucapa', 'Xá-Muteba'],
    'Lunda Sul': ['Cacolo', 'Dala', 'Muconda', 'Saurimo'],
    'Malanje': ['Cacuso', 'Calandula', 'Cambundi-Catembo', 'Cangandala', 'Caombo', 'Cuaba Nzogo', 'Cunda-dia-Baze', 'Luquembo', 'Malanje', 'Marimba', 'Massango', 'Mucari', 'Quela', 'Quirima'],
    'Moxico': ['Alto Zambeze', 'Bundas', 'Camanongue', 'Léua', 'Luau', 'Luacano', 'Luchazes', 'Cameia', 'Moxico'],
    'Namibe': ['Bibala', 'Camucuio', 'Moçâmedes', 'Tômbua', 'Virei'],
    'Uíge': ['Alto Cauale', 'Ambuíla', 'Bembe', 'Buengas', 'Bungo', 'Damba', 'Milunga', 'Mucaba', 'Negage', 'Puri', 'Quimbele', 'Quitexe', 'Sanza Pombo', 'Songo', 'Uíge', 'Zombo'],
    'Zaire': ['Cuimba', 'Mabanza Congo', 'Noqui', 'Nezeto', 'Soy', 'Tomboco']
};

function atualizarMunicipios() {
    const provSelect = document.getElementById('provincia_nascimento_select');
    const munSelect = document.getElementById('municipio_nascimento_select');
    const prov = provSelect.value;
    munSelect.innerHTML = '<option value="">Selecione o município...</option>';
    if (prov && municipiosPorProvincia[prov]) {
        municipiosPorProvincia[prov].forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.text = m;
            munSelect.appendChild(opt);
        });
    }
    sincronizar();
}

function sincronizar() {
    const nac = document.getElementById('id_nacionalidade').value;
    const finalMun = document.getElementById('id_local_nascimento_final');
    const finalProv = document.getElementById('id_provincia_nascimento_final');
    if (nac === 'Angolana') {
        finalMun.value = document.getElementById('municipio_nascimento_select').value;
        finalProv.value = document.getElementById('provincia_nascimento_select').value;
    } else {
        finalMun.value = document.getElementById('municipio_nascimento_manual').value;
        finalProv.value = document.getElementById('provincia_nascimento_manual').value;
    }
}

function alternarNacionalidade() {
    const nac = document.getElementById('id_nacionalidade').value;
    const isAngola = nac === 'Angolana';
    document.getElementById('div_provincia_select').classList.toggle('d-none', !isAngola);
    document.getElementById('div_municipio_select').classList.toggle('d-none', !isAngola);
    document.getElementById('div_provincia_manual').classList.toggle('d-none', isAngola);
    document.getElementById('div_municipio_manual').classList.toggle('d-none', isAngola);
    
    // Atualizar requireds baseado na visibilidade
    const pSel = document.getElementById('provincia_nascimento_select');
    const mSel = document.getElementById('municipio_nascimento_select');
    const pMan = document.getElementById('provincia_nascimento_manual');
    const mMan = document.getElementById('municipio_nascimento_manual');
    
    if (isAngola) {
        pSel.required = true;
        mSel.required = true;
        pMan.required = false;
        mMan.required = false;
    } else {
        pSel.required = false;
        mSel.required = false;
        pMan.required = false; // Como pedido, não obrigatório para estrangeiros
        mMan.required = false;
    }
    sincronizar();
}

document.addEventListener('DOMContentLoaded', () => {
    const pSel = document.getElementById('provincia_nascimento_select');
    const mSel = document.getElementById('municipio_nascimento_select');
    const nSel = document.getElementById('id_nacionalidade');
    const pMan = document.getElementById('provincia_nascimento_manual');
    const mMan = document.getElementById('municipio_nascimento_manual');
    
    pSel.addEventListener('change', atualizarMunicipios);
    mSel.addEventListener('change', sincronizar);
    nSel.addEventListener('change', alternarNacionalidade);
    pMan.addEventListener('input', sincronizar);
    mMan.addEventListener('input', sincronizar);

    // Lógica de Foto
    const fotoInput = document.getElementById('id_foto');
    const photoPreview = document.getElementById('photo_preview');
    const placeholderIcon = document.getElementById('placeholder_icon');

    fotoInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.style.backgroundImage = `url(${e.target.result})`;
                photoPreview.style.backgroundSize = 'cover';
                photoPreview.style.backgroundPosition = 'center';
                placeholderIcon.style.display = 'none';
                document.getElementById('id_foto_base64').value = e.target.result;
            }
            reader.readAsDataURL(file);
        }
    });

    // Webcam
    const btnWebcam = document.getElementById('btn_webcam');
    const btnCapture = document.getElementById('btn_capture');
    const btnCancelWebcam = document.getElementById('btn_cancel_webcam');
    const video = document.getElementById('webcam_video');
    const canvas = document.getElementById('photo_canvas');
    let stream = null;

    btnWebcam.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            placeholderIcon.style.display = 'none';
            photoPreview.style.backgroundImage = 'none';
            btnWebcam.classList.add('d-none');
            btnCapture.classList.remove('d-none');
            btnCancelWebcam.classList.remove('d-none');
        } catch (err) { alert("Erro webcam: " + err); }
    });

    btnCapture.addEventListener('click', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const data = canvas.toDataURL('image/jpeg');
        photoPreview.style.backgroundImage = `url(${data})`;
        photoPreview.style.backgroundSize = 'cover';
        document.getElementById('id_foto_base64').value = data;
        pararWebcam();
    });

    btnCancelWebcam.addEventListener('click', pararWebcam);
    function pararWebcam() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        video.style.display = 'none';
        if (!document.getElementById('id_foto_base64').value) placeholderIcon.style.display = 'block';
        btnWebcam.classList.remove('d-none');
        btnCapture.classList.add('d-none');
        btnCancelWebcam.classList.add('d-none');
    }

    // Navegação
    const btnNext = document.getElementById('btn_next');
    const btnPrev = document.getElementById('btn_prev');
    const btnSubmit = document.getElementById('btn_submit');
    const form = document.getElementById('inscricaoForm');
    let currentStep = 1;

    function updateWizard() {
        document.querySelectorAll('.form-step').forEach(s => s.classList.toggle('active', s.dataset.step == currentStep));
        document.querySelectorAll('.wizard-step').forEach(s => {
            s.classList.toggle('active', s.dataset.step == currentStep);
            s.classList.toggle('completed', s.dataset.step < currentStep);
        });

        // Toggle required para campos apenas da etapa atual
        document.querySelectorAll('.form-step').forEach(step => {
            const inputs = step.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (step.dataset.step == currentStep) {
                    if (input.dataset.requiredOriginal === 'true') input.required = true;
                } else {
                    if (input.required) input.dataset.requiredOriginal = 'true';
                    input.required = false;
                }
            });
        });

        btnPrev.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        btnNext.classList.toggle('d-none', currentStep === 4);
        btnSubmit.classList.toggle('d-none', currentStep !== 4);
    }

    // Marcar campos originalmente requeridos
    document.querySelectorAll('.form-step [required]').forEach(el => el.dataset.requiredOriginal = 'true');

    btnNext.addEventListener('click', () => {
        const stepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        let valid = true;
        let firstInvalid = null;
        
        stepEl.querySelectorAll('input, select, textarea').forEach(i => {
            if (i.required && !i.value) {
                i.classList.add('is-invalid');
                valid = false;
                if (!firstInvalid) firstInvalid = i;
            } else {
                i.classList.remove('is-invalid');
            }
        });

        if (!valid) {
            Swal.fire({
                icon: 'error',
                title: 'Campos Obrigatórios',
                text: 'Por favor, preencha todos os campos marcados com * antes de prosseguir.',
                confirmButtonColor: '#1e3a8a'
            });
            if (firstInvalid) firstInvalid.focus();
            return;
        }

        if (currentStep < 4) { currentStep++; updateWizard(); }
    });

    btnPrev.addEventListener('click', () => { if (currentStep > 1) { currentStep--; updateWizard(); } });

    form.addEventListener('submit', (e) => {
        let valid = true;
        document.querySelectorAll('.form-step[data-step="4"] input, .form-step[data-step="4"] select, .form-step[data-step="4"] textarea').forEach(i => {
            if (i.required && !i.value) {
                i.classList.add('is-invalid');
                valid = false;
            }
        });

        if (!valid) {
            e.preventDefault();
            Swal.fire({
                icon: 'error',
                title: 'Campos Obrigatórios',
                text: 'Por favor, preencha as configurações obrigatórias.',
                confirmButtonColor: '#1e3a8a'
            });
            return;
        }
        
        sincronizar();
        console.log("Submetendo formulário...");
    });

    updateWizard();
    alternarNacionalidade();
    if (pSel.value) atualizarMunicipios();
});
</script>
{% endblock %}