{% extends 'core/base.html' %}

{% block title %}Inscrição - {{ curso.nome }}{% endblock %}

{% block content %}
<div class="container-fluid px-4 py-4" style="background-color: #f0f2f5; min-height: 100vh;">
    <!-- Modern Header & Back Button -->
    <div class="row align-items-center mb-4">
        <div class="col-12">
            <a href="{% url 'nova_matricula' %}" class="d-inline-flex align-items-center text-decoration-none text-muted fw-medium mb-3 transition-all hover-translate">
                <div class="bg-dark shadow-sm rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px;">
                    <i class="bi bi-arrow-left text-white"></i>
                </div>
                <span>Dashboard</span>
            </a>
            <div class="d-flex justify-content-between align-items-end">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-1" style="font-size: 0.8rem;">
                            <li class="breadcrumb-item"><a href="{% url 'painel_principal' %}" class="text-decoration-none text-muted">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'nova_matricula' %}" class="text-decoration-none text-muted">Matrículas</a></li>
                            <li class="breadcrumb-item active" aria-current="page">Novo Registro</li>
                        </ol>
                    </nav>
                    <h2 class="h3 fw-bold mb-0 text-dark" style="letter-spacing: -0.5px;">Formulário de Inscrição</h2>
                </div>
                <div class="text-end">
                    <span class="badge bg-white text-primary border shadow-sm px-3 py-2 rounded-pill fw-bold">
                        Processo Nº: {% if inscricao %}{{ inscricao.numero_inscricao }}{% else %}NOVO{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <!-- Modern Wizard Card -->
            <div class="card border-0 shadow-sm overflow-hidden mb-5" style="border-radius: 24px;">
                <!-- Modern Step Indicator -->
                <div class="bg-white border-bottom p-4">
                    <div class="modern-wizard-steps">
                        <div class="wizard-step-item active" data-step="1">
                            <div class="step-circle">1</div>
                            <div class="step-label">Identificação</div>
                        </div>
                        <div class="wizard-step-item" data-step="2">
                            <div class="step-circle">2</div>
                            <div class="step-label">Contacto</div>
                        </div>
                        <div class="wizard-step-item" data-step="3">
                            <div class="step-circle">3</div>
                            <div class="step-label">Académicos</div>
                        </div>
                        <div class="wizard-step-item" data-step="4">
                            <div class="step-circle">4</div>
                            <div class="step-label">Conta</div>
                        </div>
                        <div class="wizard-step-item" data-step="5">
                            <div class="step-circle">5</div>
                            <div class="step-label">Pagamento</div>
                        </div>
                    </div>
                    <div class="progress mt-4" style="height: 6px; border-radius: 10px;">
                        <div id="wizard_progress_bar" class="progress-bar bg-primary" role="progressbar" style="width: 20%;"></div>
                    </div>
                </div>

                <div class="card-body p-4 p-md-5">
                    <form method="post" id="inscricaoForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Etapa 1: Identificação -->
                        <div class="form-step active" data-step="1">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                    <i class="bi bi-person-vcard fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Informações de Identificação</h5>
                            </div>
                            
                            <div class="row g-4">
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div id="photo_preview" class="bg-light border rounded-4 mb-3 d-flex align-items-center justify-content-center position-relative overflow-hidden shadow-sm" style="width: 100%; aspect-ratio: 3/4; max-width: 180px; margin: 0 auto;">
                                            <i class="bi bi-person text-muted opacity-25" id="placeholder_icon" style="font-size: 5rem;"></i>
                                            <img id="image_preview_img" src="#" alt="Preview" class="d-none w-100 h-100" style="object-fit: cover;">
                                            <video id="webcam_video" style="display: none; width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                            <canvas id="photo_canvas" style="display: none;"></canvas>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <label class="btn btn-outline-dark btn-sm rounded-3">
                                                <i class="bi bi-upload me-1"></i> Do PC
                                                <input type="file" name="foto" id="id_foto" hidden accept="image/*" onchange="previewFile(this)">
                                            </label>
                                            <button type="button" id="btn_webcam" class="btn btn-outline-primary btn-sm rounded-3">
                                                <i class="bi bi-camera me-1"></i> Webcam
                                            </button>
                                            <button type="button" id="btn_capture" class="btn btn-success btn-sm d-none rounded-3">
                                                <i class="bi bi-camera-fill me-1"></i> Capturar
                                            </button>
                                            <button type="button" id="btn_cancel_webcam" class="btn btn-danger btn-sm d-none rounded-3">
                                                <i class="bi bi-x-circle me-1"></i> Cancelar
                                            </button>
                                        </div>
                                        <input type="hidden" name="foto_base64" id="id_foto_base64">
                                    </div>
                                </div>
                                <div class="col-md-9">
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label class="form-label small fw-bold text-muted">NOME COMPLETO *</label>
                                            <input type="text" name="nome_completo_display" id="id_nome_completo_display" class="form-control bg-light border-0 py-2 shadow-none rounded-3" required placeholder="Digite seu nome completo" value="{{ form_data.nome_completo_display|default:'' }}">
                                            <input type="hidden" name="primeiro_nome" id="id_primeiro_nome" value="{{ form_data.primeiro_nome|default:'' }}">
                                            <input type="hidden" name="nomes_meio" id="id_nomes_meio" value="{{ form_data.nomes_meio|default:'' }}">
                                            <input type="hidden" name="apelido" id="id_apelido" value="{{ form_data.apelido|default:'' }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">SEXO *</label>
                                            <select name="sexo" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                                <option value="">Selecione...</option>
                                                <option value="M" {% if form_data.sexo == 'M' %}selected{% endif %}>Masculino</option>
                                                <option value="F" {% if form_data.sexo == 'F' %}selected{% endif %}>Feminino</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">DATA DE NASCIMENTO *</label>
                                            <input type="date" name="data_nascimento" class="form-control bg-light border-0 py-2 shadow-none rounded-3" required value="{{ form_data.data_nascimento|default:'' }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">TIPO DE DOCUMENTO *</label>
                                            <select name="tipo_documento" id="id_tipo_documento" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                                <option value="BI" {% if form_data.tipo_documento == 'BI' or not form_data.tipo_documento %}selected{% endif %}>BI (Bilhete de Identidade)</option>
                                                <option value="Passaporte" {% if form_data.tipo_documento == 'Passaporte' %}selected{% endif %}>Passaporte</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">NÚMERO DO DOCUMENTO *</label>
                                            <input type="text" name="bilhete_identidade" id="bilhete_identidade" class="form-control bg-light border-0 py-2 shadow-none rounded-3 check-exists" data-campo="bilhete_identidade" required placeholder="Digite o número" value="{{ form_data.bilhete_identidade|default:'' }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">VALIDADE DO DOCUMENTO *</label>
                                            <input type="date" name="data_validade_bi" class="form-control bg-light border-0 py-2 shadow-none rounded-3" required value="{{ form_data.data_validade_bi|default:'' }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">NACIONALIDADE *</label>
                                            <select name="nacionalidade" id="id_nacionalidade" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                                <option value="Angolana" {% if form_data.nacionalidade == 'Angolana' or not form_data.nacionalidade %}selected{% endif %}>Angolana</option>
                                                <option value="Outra" {% if form_data.nacionalidade == 'Outra' %}selected{% endif %}>Outra</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">PROVÍNCIA *</label>
                                            <select name="provincia" id="id_provincia" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                                <option value="">Selecione a província...</option>
                                                <option value="Bengo">Bengo</option>
                                                <option value="Benguela">Benguela</option>
                                                <option value="Bié">Bié</option>
                                                <option value="Cabinda">Cabinda</option>
                                                <option value="Cuando Cubango">Cuando Cubango</option>
                                                <option value="Cuanza Norte">Cuanza Norte</option>
                                                <option value="Cuanza Sul">Cuanza Sul</option>
                                                <option value="Cunene">Cunene</option>
                                                <option value="Huambo">Huambo</option>
                                                <option value="Huíla">Huíla</option>
                                                <option value="Luanda">Luanda</option>
                                                <option value="Lunda Norte">Lunda Norte</option>
                                                <option value="Lunda Sul">Lunda Sul</option>
                                                <option value="Malanje">Malanje</option>
                                                <option value="Moxico">Moxico</option>
                                                <option value="Namibe">Namibe</option>
                                                <option value="Uíge">Uíge</option>
                                                <option value="Zaire">Zaire</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-muted">MUNICÍPIO *</label>
                                            <select name="municipio" id="id_municipio" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required disabled>
                                                <option value="">Selecione primeiro a província...</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 2: Contacto -->
                        <div class="form-step" data-step="2">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                    <i class="bi bi-telephone fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Canais de Contacto</h5>
                            </div>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">TELEFONE PRINCIPAL *</label>
                                    <input type="tel" name="telefone" class="form-control bg-light border-0 py-2 shadow-none rounded-3 check-exists" required value="{{ form_data.telefone|default:'' }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">TELEFONE ALTERNATIVO</label>
                                    <input type="tel" name="telefone_alternativo" class="form-control bg-light border-0 py-2 shadow-none rounded-3" value="{{ form_data.telefone_alternativo|default:'' }}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">E-MAIL (SERÁ SEU ACESSO) *</label>
                                    <input type="email" name="email_recuperacao" class="form-control bg-light border-0 py-2 shadow-none rounded-3 check-exists" required value="{{ form_data.email_recuperacao|default:'' }}">
                                    <div class="alert alert-info mt-3 border-0 bg-primary bg-opacity-10 text-primary small d-flex align-items-center gap-2" style="border-radius: 12px;">
                                        <i class="bi bi-info-circle-fill"></i>
                                        Este e-mail será utilizado para login, recuperação de senha e notificações oficiais.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 3: Académicos -->
                        <div class="form-step" data-step="3">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                    <i class="bi bi-mortarboard fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Informações Académicas</h5>
                            </div>
                            <div class="row g-4">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label small fw-bold text-muted text-uppercase">CURSO DESEJADO *</label>
                                    <select name="curso" id="id_curso_selection" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                        <option value="">Selecione um curso...</option>
                                        {% for c in cursos %}
                                            <option value="{{ c.id }}" data-vagas="{{ c.vagas_disponiveis }}" {% if c.id == curso.id or form_data.curso == c.id|stringformat:"i" %}selected{% endif %}>
                                                {{ c.nome }} ({{ c.vagas_disponiveis }} vagas)
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div id="vagas_feedback" class="form-text mt-2 d-none"></div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">NÍVEL PRETENDIDO *</label>
                                <div class="col-md-6 d-none">
                                    <label class="form-label small fw-bold text-muted">ANO LECTIVO *</label>
                                    <select name="ano_academico" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                        {% for ano in anos_academicos %}
                                            <option value="{{ ano.id }}" {% if ano.id == ano_atual.id %}selected{% endif %}>{{ ano.codigo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">TURNO *</label>
                                    <select name="turno" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                        <option value="Manhã" selected>Manhã</option>
                                        <option value="Tarde">Tarde</option>
                                        <option value="Noite">Noite</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 4: Conta -->
                        <div class="form-step" data-step="4">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                    <i class="bi bi-shield-lock fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Dados de Acesso</h5>
                            </div>
                            <div class="row g-4">
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">NOME DE USUÁRIO</label>
                                    <input type="text" name="username" id="id_username" class="form-control bg-light border-0 py-2 shadow-none rounded-3" readonly placeholder="Preenchido automaticamente pelo e-mail">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">SENHA GERADA</label>
                                    <div class="input-group bg-light rounded-3 overflow-hidden border-0">
                                        <span class="input-group-text border-0 bg-transparent text-muted"><i class="bi bi-key-fill"></i></span>
                                        <input type="text" name="password_display" id="id_password_display" class="form-control border-0 bg-transparent py-2 fw-bold text-primary" readonly style="font-family: monospace; letter-spacing: 1px;">
                                        <input type="hidden" name="password" id="id_password">
                                    </div>
                                    <p class="form-text small mt-2">
                                        <i class="bi bi-exclamation-triangle-fill text-warning me-1"></i>
                                        <strong>Guarde esta senha!</strong> Ela será necessária para consultar seu resultado.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 5: Pagamento -->
                        <div class="form-step" data-step="5">
                            <div class="d-flex align-items-center gap-3 mb-4">
                                <div class="bg-primary bg-opacity-10 p-2 rounded-3 text-primary">
                                    <i class="bi bi-cash-stack fs-4"></i>
                                </div>
                                <h5 class="fw-bold mb-0">Taxa de Inscrição</h5>
                            </div>
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">MÉTODO DE PAGAMENTO *</label>
                                    <select name="metodo_pagamento" class="form-select bg-light border-0 py-2 shadow-none rounded-3" required>
                                        <option value="multicaixa" selected>Multicaixa (Transferência/Depósito)</option>
                                        <option value="referencia">Referência Bancária</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small fw-bold text-muted">NÚMERO DO COMPROVANTE *</label>
                                    <input type="text" name="numero_comprovante" class="form-control bg-light border-0 py-2 shadow-none rounded-3" placeholder="Ex: 123456789">
                                </div>
                                <div class="col-12">
                                    <label class="form-label small fw-bold text-muted">ANEXAR COMPROVATIVO (PDF/IMAGEM) *</label>
                                    <input type="file" name="comprovativo_pagamento" class="form-control bg-light border-0 py-2 shadow-none rounded-3" accept="image/*,.pdf" required>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                            <button type="button" class="btn btn-light px-4 py-2 d-flex align-items-center gap-2" id="btn_prev" style="border-radius: 10px;">
                                <i class="bi bi-chevron-left"></i> Anterior
                            </button>
                            <button type="button" class="btn btn-primary px-5 py-2 d-flex align-items-center gap-2" id="btn_next" style="border-radius: 10px; font-weight: 600;">
                                Próximo <i class="bi bi-chevron-right"></i>
                            </button>
                            <button type="submit" class="btn btn-success px-5 py-2 d-none d-flex align-items-center gap-2" id="btn_submit" style="border-radius: 10px; font-weight: 600;">
                                Concluir Inscrição <i class="bi bi-check-circle"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .transition-all { transition: all 0.3s ease; }
    .hover-translate:hover { transform: translateX(-5px); color: #000 !important; }
    
    .modern-wizard-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
    }
    
    .wizard-step-item {
        flex: 1;
        text-align: center;
        position: relative;
        z-index: 1;
    }
    
    .step-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #e2e8f0;
        color: #64748b;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        font-weight: bold;
        font-size: 0.85rem;
        transition: all 0.3s;
    }
    
    .step-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #94a3b8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .wizard-step-item.active .step-circle {
        background-color: #2563eb;
        color: white;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
    }
    
    .wizard-step-item.active .step-label {
        color: #1e3a8a;
    }
    
    .wizard-step-item.completed .step-circle {
        background-color: #10b981;
        color: white;
    }
    
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.4s ease-out; }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .form-control:focus, .form-select:focus {
        background-color: white !important;
        border: 1px solid #2563eb !important;
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.05) !important;
    }
</style>

<script>
    function previewFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        const mainPreview = document.getElementById('main_image_preview');
        const mainPlaceholder = document.getElementById('main_placeholder_icon');
        const placeholder = document.getElementById('placeholder_icon');
        const video = document.getElementById('webcam_video');
        const smallPreview = document.getElementById('image_preview_small');

        reader.onloadend = function () {
            // Update Main Preview
            if (mainPreview) {
                mainPreview.src = reader.result;
                mainPreview.classList.remove('d-none');
            }
            if (mainPlaceholder) {
                mainPlaceholder.classList.add('d-none');
            }
            
            // Update Small Preview inside Wizard
            if (smallPreview) {
                smallPreview.src = reader.result;
                smallPreview.classList.remove('d-none');
            }
            if (placeholder) {
                placeholder.classList.add('d-none');
            }
            if (video) {
                video.style.display = 'none';
            }
        }

        if (file) {
            reader.readAsDataURL(file);
        }
    }

    function previewFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        const mainPreview = document.getElementById('main_image_preview');
        const mainPlaceholder = document.getElementById('main_placeholder_icon');
        const placeholder = document.getElementById('placeholder_icon');
        const video = document.getElementById('webcam_video');
        const smallPreview = document.getElementById('image_preview_small');

        reader.onloadend = function () {
            // Update Main Preview
            if (mainPreview) {
                mainPreview.src = reader.result;
                mainPreview.classList.remove('d-none');
            }
            if (mainPlaceholder) {
                mainPlaceholder.classList.add('d-none');
            }
            
            // Update Small Preview inside Wizard
            if (smallPreview) {
                smallPreview.src = reader.result;
                smallPreview.classList.remove('d-none');
            }
            if (placeholder) {
                placeholder.classList.add('d-none');
            }
            if (video) {
                video.style.display = 'none';
            }
        }

        if (file) {
            reader.readAsDataURL(file);
        }
    }

    function previewFile(input) {
        const file = input.files[0];
        const reader = new FileReader();
        const mainPreview = document.getElementById('main_image_preview');
        const mainPlaceholder = document.getElementById('main_placeholder_icon');
        const placeholder = document.getElementById('placeholder_icon');
        const video = document.getElementById('webcam_video');
        const smallPreview = document.getElementById('image_preview_img');

        reader.onloadend = function () {
            // Update Main Preview (if it exists)
            if (mainPreview) {
                mainPreview.src = reader.result;
                mainPreview.classList.remove('d-none');
            }
            if (mainPlaceholder) {
                mainPlaceholder.classList.add('d-none');
            }
            
            // Update Small Preview inside Wizard
            if (smallPreview) {
                smallPreview.src = reader.result;
                smallPreview.classList.remove('d-none');
            }
            if (placeholder) {
                placeholder.classList.add('d-none');
            }
            if (video) {
                video.style.display = 'none';
            }
        }

        if (file) {
            reader.readAsDataURL(file);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 5;
    const form = document.getElementById('inscricaoForm');
    // Adicionar dados de províncias e municípios de Angola
    const angolaData = {
        "Bengo": ["Ambriz", "Bula Atumba", "Dande", "Dembos", "Nambuangongo", "Pango Aluquém"],
        "Benguela": ["Balombo", "Baía Farta", "Benguela", "Bocoio", "Caimbambo", "Catumbela", "Chongoroi", "Ganda", "Lobito", "Mariano Machado"],
        "Bié": ["Andulo", "Camacupa", "Catabola", "Chitembo", "Chinguar", "Cuemba", "Cunhinga", "Kuito", "Nharea"],
        "Cabinda": ["Belize", "Buco-Zau", "Cabinda", "Cacongo"],
        "Cuando Cubango": ["Calai", "Cuangar", "Cuchi", "Cuito Cuanavale", "Dirico", "Mavinga", "Menongue", "Nancova", "Rivungo"],
        "Cuanza Norte": ["Ambaca", "Bangue", "Bolongongo", "Cambambe", "Cazengo", "Golungo Alto", "Gonguembo", "Lucala", "Quiculungo", "Samba Caju"],
        "Cuanza Sul": ["Amboim", "Cassongue", "Cela", "Conda", "Ebo", "Libolo", "Mussende", "Porto Amboim", "Quibala", "Quilenda", "Seles", "Sumbe"],
        "Cunene": ["Cahama", "Cuanhama", "Curoca", "Cuvelai", "Namacunde", "Ombadja"],
        "Huambo": ["Bailundo", "Caála", "Catchiungo", "Ecunha", "Huambo", "Londuimbale", "Longonjo", "Mungo", "Tchicala-Tcholoanga", "Tchindjenje", "Ucuma"],
        "Huíla": ["Caconda", "Cacula", "Caluquembe", "Chiange", "Chibia", "Chicomba", "Chipindo", "Cuvango", "Humpata", "Jamba", "Lubango", "Matala", "Quilengues", "Quipungo"],
        "Luanda": ["Belas", "Cacuaco", "Cazenga", "Icolo e Bengo", "Luanda", "Quiçama", "Kilamba Kiaxi", "Talatona", "Viana"],
        "Lunda Norte": ["Cambulo", "Capenda-Camulemba", "Caungula", "Chitato", "Cuilo", "Cuango", "Lubalo", "Lucapa", "Xá-Muteba"],
        "Lunda Sul": ["Cacolo", "Dala", "Muconda", "Saurimo"],
        "Malanje": ["Cacuso", "Calandula", "Cambundi-Catembo", "Cangandala", "Caombo", "Cuaba Nzogo", "Cunda-dia-Baze", "Luquembo", "Malanje", "Marimba", "Massango", "Mucari", "Quela", "Quirima"],
        "Moxico": ["Alto Zambeze", "Bundas", "Camanongue", "Cameia", "Léua", "Luau", "Luacano", "Luchazes", "Moxico"],
        "Namibe": ["Bibala", "Camucuio", "Moçâmedes", "Tômbua", "Virei"],
        "Uíge": ["Alto Cauale", "Ambuíla", "Bembe", "Buengas", "Bungo", "Cangola", "Damba", "Mucaba", "Negage", "Puri", "Quimbele", "Quitexe", "Sanza Pombo", "Songo", "Uíge", "Zombo"],
        "Zaire": ["Cuimba", "M'banza Kongo", "Noqui", "N'zeto", "Soyo", "Sumbula"]
    };

    const nacionalidadeSelect = document.getElementById('id_nacionalidade');
    const provinciaSelect = document.getElementById('id_provincia');
    const municipioSelect = document.getElementById('id_municipio');

    function toggleProvinciaMunicipio() {
        const isAngolana = nacionalidadeSelect.value === 'Angolana';
        
        if (isAngolana) {
            // Transformar em selects se forem inputs
            if (provinciaSelect.tagName === 'INPUT') {
                const newProvincia = document.createElement('select');
                newProvincia.name = 'provincia';
                newProvincia.id = 'id_provincia';
                newProvincia.className = 'form-select bg-light border-0 py-2 shadow-none rounded-3';
                newProvincia.required = true;
                newProvincia.innerHTML = '<option value="">Selecione a província...</option>' + 
                    Object.keys(angolaData).map(p => `<option value="${p}">${p}</option>`).join('');
                provinciaSelect.replaceWith(newProvincia);
                newProvincia.addEventListener('change', updateMunicipios);
            }
            if (municipioSelect.tagName === 'INPUT') {
                const newMunicipio = document.createElement('select');
                newMunicipio.name = 'municipio';
                newMunicipio.id = 'id_municipio';
                newMunicipio.className = 'form-select bg-light border-0 py-2 shadow-none rounded-3';
                newMunicipio.required = true;
                newMunicipio.disabled = true;
                newMunicipio.innerHTML = '<option value="">Selecione primeiro a província...</option>';
                municipioSelect.replaceWith(newMunicipio);
            }
        } else {
            // Transformar em inputs se forem selects
            if (provinciaSelect.tagName === 'SELECT') {
                const newProvincia = document.createElement('input');
                newProvincia.type = 'text';
                newProvincia.name = 'provincia';
                newProvincia.id = 'id_provincia';
                newProvincia.className = 'form-control bg-light border-0 py-2 shadow-none rounded-3';
                newProvincia.required = true;
                newProvincia.placeholder = 'Digite a província';
                provinciaSelect.replaceWith(newProvincia);
            }
            if (municipioSelect.tagName === 'SELECT') {
                const newMunicipio = document.createElement('input');
                newMunicipio.type = 'text';
                newMunicipio.name = 'municipio';
                newMunicipio.id = 'id_municipio';
                newMunicipio.className = 'form-control bg-light border-0 py-2 shadow-none rounded-3';
                newMunicipio.required = true;
                newMunicipio.placeholder = 'Digite o município';
                municipioSelect.replaceWith(newMunicipio);
            }
        }
    }

    function updateMunicipios() {
        const selectedProvincia = this.value;
        const currentMunicipioSelect = document.getElementById('id_municipio');
        
        if (currentMunicipioSelect.tagName === 'SELECT') {
            currentMunicipioSelect.innerHTML = '<option value="">Selecione o município...</option>';
            
            if (selectedProvincia && angolaData[selectedProvincia]) {
                angolaData[selectedProvincia].forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    currentMunicipioSelect.appendChild(option);
                });
                currentMunicipioSelect.disabled = false;
            } else {
                currentMunicipioSelect.disabled = true;
                currentMunicipioSelect.innerHTML = '<option value="">Selecione primeiro a província...</option>';
            }
        }
    }

    if (nacionalidadeSelect) {
        nacionalidadeSelect.addEventListener('change', toggleProvinciaMunicipio);
    }

    const cursoSelect = document.getElementById('id_curso_selection');
    const vagasFeedback = document.getElementById('vagas_feedback');

    if (cursoSelect) {
        cursoSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const vagas = selectedOption.getAttribute('data-vagas');
            
            if (this.value && vagas !== null) {
                vagasFeedback.classList.remove('d-none');
                if (parseInt(vagas) <= 0) {
                    vagasFeedback.innerHTML = `<i class="bi bi-exclamation-triangle-fill text-danger me-1"></i> <span class="text-danger fw-bold">Curso sem vagas disponíveis no momento.</span>`;
                    btnNext.disabled = true;
                } else {
                    vagasFeedback.innerHTML = `<i class="bi bi-check-circle-fill text-success me-1"></i> <span class="text-success">${vagas} vagas disponíveis.</span>`;
                    btnNext.disabled = false;
                }
            } else {
                vagasFeedback.classList.add('d-none');
                btnNext.disabled = false;
            }
        });
    }

    if (provinciaSelect) {
        provinciaSelect.addEventListener('change', updateMunicipios);
    }

    const btnNext = document.getElementById('btn_next');
    const btnPrev = document.getElementById('btn_prev');
    const btnSubmit = document.getElementById('btn_submit');
    const progressBar = id = 'wizard_progress_bar';
    
    function updateWizard() {
        // Update Steps UI
        document.querySelectorAll('.form-step').forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step) === currentStep);
        });
        
        document.querySelectorAll('.wizard-step-item').forEach((item, idx) => {
            const stepNum = idx + 1;
            item.classList.toggle('active', stepNum === currentStep);
            item.classList.toggle('completed', stepNum < currentStep);
        });
        
        // Progress bar
        document.getElementById('wizard_progress_bar').style.width = ((currentStep / totalSteps) * 100) + '%';
        
        // Buttons visibility
        btnPrev.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        if (currentStep === totalSteps) {
            btnNext.classList.add('d-none');
            btnSubmit.classList.remove('d-none');
        } else {
            btnNext.classList.remove('d-none');
            btnSubmit.classList.add('d-none');
        }
        
        // Auto-generate password on Step 4
        if (currentStep === 4 && !document.getElementById('id_password').value) {
            generatePassword();
        }
    }
    
    btnNext.addEventListener('click', () => {
        if (validateStep(currentStep)) {
            currentStep++;
            updateWizard();
            window.scrollTo(0, 0);
        }
    });
    
    btnPrev.addEventListener('click', () => {
        currentStep--;
        updateWizard();
        window.scrollTo(0, 0);
    });
    
    function validateStep(step) {
        const stepContainer = document.querySelector(`.form-step[data-step="${step}"]`);
        const inputs = stepContainer.querySelectorAll('input[required], select[required]');
        let valid = true;
        
        inputs.forEach(input => {
            if (!input.value) {
                input.classList.add('is-invalid');
                valid = false;
            } else {
                input.classList.remove('is-invalid');
            }
        });
        
        return valid;
    }
    
    function generatePassword() {
        const pass = Math.random().toString(36).slice(-8).toUpperCase();
        document.getElementById('id_password_display').value = pass;
        document.getElementById('id_password').value = pass;
    }
    
    // Auto-username from email
    document.querySelector('input[name="email_recuperacao"]').addEventListener('input', function() {
        document.getElementById('id_username').value = this.value;
    });

    updateWizard();
});
</script>
{% endblock %}
