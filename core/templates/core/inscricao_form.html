{% extends 'core/base.html' %}

{% block title %}Inscri√ß√£o - {{ curso.nome }}{% endblock %}

{% block content %}
<div class="container my-5 pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 mb-5">
            <!-- Formul√°rio com Barra de Progresso -->
            <div class="card shadow">
                <div class="card-header bg-custom text-white py-2 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Formul√°rio de Inscri√ß√£o - {{ curso.nome }}</h5>
                    <span class="badge bg-white text-primary">Processo N¬∫: {% if inscricao %}{{ inscricao.numero_inscricao }}{% else %}NOVO{% endif %}</span>
                </div>
                
                <!-- Barra de Progresso Visual -->
                <div class="progress rounded-0" style="height: 6px;">
                    <div id="wizard_progress_bar" class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar" style="width: 20%;"></div>
                </div>

                <!-- Barra de Passos -->
                <div class="py-3 px-2" style="background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                    <div class="progress-wizard">
                        <div class="wizard-step active" data-step="1">
                            <div class="wizard-icon"><i class="bi bi-person-badge"></i></div>
                            <div class="wizard-label">Identifica√ß√£o</div>
                        </div>
                        <div class="wizard-step" data-step="2">
                            <div class="wizard-icon"><i class="bi bi-telephone"></i></div>
                            <div class="wizard-label">Contacto</div>
                        </div>
                        <div class="wizard-step" data-step="3">
                            <div class="wizard-icon"><i class="bi bi-book"></i></div>
                            <div class="wizard-label">Acad√©micos</div>
                        </div>
                        <div class="wizard-step" data-step="4">
                            <div class="wizard-icon"><i class="bi bi-shield-lock"></i></div>
                            <div class="wizard-label">Conta</div>
                        </div>
                        <div class="wizard-step" data-step="5">
                            <div class="wizard-icon"><i class="bi bi-cash-coin"></i></div>
                            <div class="wizard-label">Pagamento</div>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <form method="post" id="inscricaoForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Etapa 1: Identifica√ß√£o -->
                        <div class="form-step active" data-step="1">
                            <h5 class="mb-3"><i class="bi bi-person-badge me-2"></i>Identifica√ß√£o</h5>
                            <div class="row">
                                <div class="col-md-3 mb-3 text-center">
                                    <div id="photo_preview" class="border rounded mb-2 d-flex align-items-center justify-content-center position-relative" style="width: 150px; height: 180px; margin: 0 auto; background-color: #f8f9fa; overflow: hidden;">
                                        <i class="bi bi-person" id="placeholder_icon" style="font-size: 4rem; color: #dee2e6;"></i>
                                        <video id="webcam_video" style="display: none; width: 100%; height: 100%; object-fit: cover;" autoplay playsinline></video>
                                        <canvas id="photo_canvas" style="display: none;"></canvas>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <label class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-upload me-1"></i> Do PC
                                            <input type="file" name="foto" id="id_foto" hidden accept="image/*">
                                        </label>
                                        <button type="button" id="btn_webcam" class="btn btn-sm btn-outline-secondary">
                                            <i class="bi bi-camera me-1"></i> Webcam
                                        </button>
                                        <button type="button" id="btn_capture" class="btn btn-sm btn-success d-none">
                                            <i class="bi bi-camera-fill me-1"></i> Capturar
                                        </button>
                                        <button type="button" id="btn_cancel_webcam" class="btn btn-sm btn-danger d-none">
                                            <i class="bi bi-x-circle me-1"></i> Cancelar
                                        </button>
                                    </div>
                                    <input type="hidden" name="foto_base64" id="id_foto_base64">
                                </div>
                                <div class="col-md-9">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Nome Completo *</label>
                                            <input type="text" name="nome_completo_display" id="id_nome_completo_display" class="form-control" required placeholder="Digite o nome completo" value="{{ form_data.nome_completo_display|default:'' }}">
                                            <input type="hidden" name="primeiro_nome" id="id_primeiro_nome" value="{{ form_data.primeiro_nome|default:'' }}">
                                            <input type="hidden" name="nomes_meio" id="id_nomes_meio" value="{{ form_data.nomes_meio|default:'' }}">
                                            <input type="hidden" name="apelido" id="id_apelido" value="{{ form_data.apelido|default:'' }}">
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Sexo *</label>
                                            <select name="sexo" class="form-select" required>
                                                <option value="">Selecione...</option>
                                                <option value="M" {% if form_data.sexo == 'M' %}selected{% endif %}>Masculino</option>
                                                <option value="F" {% if form_data.sexo == 'F' %}selected{% endif %}>Feminino</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Data de Nascimento *</label>
                                            <input type="date" name="data_nascimento" id="data_nascimento" class="form-control" required value="{{ form_data.data_nascimento|default:'' }}">
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Tipo de Documento *</label>
                                            <select name="tipo_documento" id="id_tipo_documento" class="form-select" required>
                                                <option value="BI" {% if form_data.tipo_documento == 'BI' or not form_data.tipo_documento %}selected{% endif %}>BI (Bilhete de Identidade)</option>
                                                <option value="Passaporte" {% if form_data.tipo_documento == 'Passaporte' %}selected{% endif %}>Passaporte</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">N√∫mero do Documento *</label>
                                            <input type="text" name="bilhete_identidade" id="bilhete_identidade" class="form-control check-exists" data-campo="bilhete_identidade" required placeholder="Digite o n√∫mero do documento" value="{{ form_data.bilhete_identidade|default:'' }}">
                                            <small class="text-muted" id="doc_help_text">O n√∫mero do BI deve ser √∫nico no sistema.</small>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Data de Validade (BI) *</label>
                                            <input type="date" name="data_validade_bi" id="id_data_validade_bi" class="form-control" required value="{{ form_data.data_validade_bi|default:'' }}">
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nacionalidade *</label>
                                            <select name="nacionalidade" id="id_nacionalidade" class="form-select" required>
                                                <option value="Angolana" {% if form_data.nacionalidade == 'Angolana' or not form_data.nacionalidade %}selected{% endif %}>Angolana</option>
                                                <option value="Brasil" {% if form_data.nacionalidade == 'Brasil' %}selected{% endif %}>Brasil</option>
                                                <option value="Portugal" {% if form_data.nacionalidade == 'Portugal' %}selected{% endif %}>Portugal</option>
                                                <option value="Outra" {% if form_data.nacionalidade == 'Outra' %}selected{% endif %}>Outra</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Campos de Sele√ß√£o Din√¢mica -->
                                        <div class="col-md-6 mb-3" id="div_provincia_select">
                                            <label class="form-label">Prov√≠ncia de Nascimento *</label>
                                            <select id="provincia_nascimento_select" class="form-select">
                                                <option value="">Selecione a prov√≠ncia...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3" id="div_municipio_select">
                                            <label class="form-label">Munic√≠pio de Nascimento *</label>
                                            <select id="municipio_nascimento_select" class="form-select">
                                                <option value="">Selecione o munic√≠pio...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Campos de Entrada Manual -->
                                        <div class="col-md-6 mb-3 d-none" id="div_provincia_manual">
                                            <label class="form-label">Prov√≠ncia / Estado</label>
                                            <input type="text" id="provincia_nascimento_manual" class="form-control" placeholder="Digite a prov√≠ncia" value="{{ form_data.provincia_nascimento|default:'' }}">
                                        </div>
                                        <div class="col-md-6 mb-3 d-none" id="div_municipio_manual">
                                            <label class="form-label">Munic√≠pio / Cidade</label>
                                            <input type="text" id="municipio_nascimento_manual" class="form-control" placeholder="Digite o munic√≠pio" value="{{ form_data.local_nascimento|default:'' }}">
                                        </div>
                                        
                                        <!-- Campos ocultos enviados ao backend -->
                                        <input type="hidden" name="local_nascimento" id="id_local_nascimento_final" value="{{ form_data.local_nascimento|default:'' }}">
                                        <input type="hidden" name="provincia_nascimento" id="id_provincia_nascimento_final" value="{{ form_data.provincia_nascimento|default:'' }}">
                                        
                                        <div class="d-none">
                                            <input type="number" name="ano_conclusao" value="2024">
                                            <textarea name="endereco">N/A</textarea>
                                            <input type="email" name="email" value="candidato@sistema.com">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Etapa 2: Contacto -->
                        <div class="form-step" data-step="2">
                            <h5 class="mb-3"><i class="bi bi-telephone me-2"></i>Contacto</h5>
                            <p class="text-muted mb-4">Para comunica√ß√£o e recupera√ß√£o de conta.</p>
                            
                            <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Telefone Principal *</label>
                                            <input type="tel" name="telefone" class="form-control check-exists {% if error_field == 'telefone' %}is-invalid{% endif %}" data-campo="telefone" required value="{{ form_data.telefone|default:'' }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Telefone Alternativo (Opcional)</label>
                                            <input type="tel" name="telefone_alternativo" class="form-control check-exists" data-campo="telefone" value="{{ form_data.telefone_alternativo|default:'' }}">
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">E-mail *</label>
                                            <input type="email" name="email_recuperacao" id="email_recuperacao" class="form-control check-exists {% if error_field == 'email_recuperacao' %}is-invalid{% endif %}" data-campo="email_recuperacao" required value="{{ form_data.email_recuperacao|default:'' }}">
                                    <div class="mt-3 p-3 bg-light rounded border">
                                        <p class="mb-2 fw-bold">üìå O e-mail ser√° usado como:</p>
                                        <ul class="mb-0 list-unstyled ps-3">
                                            <li><i class="bi bi-check2-circle text-success me-2"></i>Username</li>
                                            <li><i class="bi bi-check2-circle text-success me-2"></i>Recupera√ß√£o de senha</li>
                                            <li><i class="bi bi-check2-circle text-success me-2"></i>Notifica√ß√µes</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 3: Acad√©micos -->
                        <div class="form-step" data-step="3">
                            <h5 class="mb-3"><i class="bi bi-book me-2"></i>Informa√ß√µes Acad√©micas</h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">N√≠vel Pretendido *</label>
                                    <select name="nivel_academico" class="form-select" required>
                                        <option value="">Selecione o n√≠vel...</option>
                                        <option value="T√©cnico" {% if form_data.nivel_academico == 'T√©cnico' %}selected{% endif %}>T√©cnico</option>
                                        <option value="Licenciatura" {% if form_data.nivel_academico == 'Licenciatura' %}selected{% endif %}>Licenciatura</option>
                                        <option value="P√≥s-gradua√ß√£o" {% if form_data.nivel_academico == 'P√≥s-gradua√ß√£o' %}selected{% endif %}>P√≥s-gradua√ß√£o</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Curso Pretendido *</label>
                                    <select name="curso" class="form-select" required>
                                        <option value="">Selecione um curso...</option>
                                        {% for curso_opt in cursos %}
                                            <option value="{{ curso_opt.id }}" {% if form_data.curso|slugify == curso_opt.id|slugify %}selected{% endif %}>{{ curso_opt.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ano Lectivo *</label>
                                    <select name="ano_academico" id="id_ano_academico" class="form-select" required>
                                        <option value="">Selecione o ano...</option>
                                        {% for ano in anos_academicos %}
                                            <option value="{{ ano.id }}" {% if form_data.ano_academico|slugify == ano.id|slugify %}selected{% endif %}>{{ ano.codigo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Turno *</label>
                                    <select name="turno" class="form-select" required>
                                        <option value="Manh√£" {% if form_data.turno == 'Manh√£' %}selected{% endif %}>Manh√£</option>
                                        <option value="Tarde" {% if form_data.turno == 'Tarde' %}selected{% endif %}>Tarde</option>
                                        <option value="Noite" {% if form_data.turno == 'Noite' %}selected{% endif %}>Noite</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 4: Dados da Conta -->
                        <div class="form-step" data-step="4">
                            <h5 class="mb-3"><i class="bi bi-shield-lock me-2"></i>Dados da Conta de Acesso</h5>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Nome de Usu√°rio (Username) *</label>
                                    <input type="text" name="username" id="id_username" class="form-control" required readonly placeholder="Ser√° preenchido automaticamente com seu e-mail">
                                    <small class="text-muted">Seu e-mail de contacto ser√° usado como nome de usu√°rio.</small>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">Senha de Acesso</label>
                                    <div class="input-group">
                                        <span class="input-group-text bg-light"><i class="bi bi-key"></i></span>
                                        <input type="text" name="password_display" id="id_password_display" class="form-control" readonly style="background-color: #f8f9fa; font-family: monospace; font-weight: bold; color: #1e3a8a;">
                                        <input type="hidden" name="password" id="id_password">
                                    </div>
                                    <div class="form-text mt-2">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Esta senha foi gerada automaticamente para si. <strong>Guarde-a com cuidado!</strong>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <div class="alert alert-info border-0 bg-info bg-opacity-10 text-dark small">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Utilize esta conta para consultar o estado da sua inscri√ß√£o e realizar matr√≠culas futuramente.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Etapa 5: Pagamento e Configura√ß√µes -->
                        <div class="form-step" data-step="5">
                            <h5 class="mb-3"><i class="bi bi-cash-coin me-2"></i>Pagamento da Inscri√ß√£o</h5>
                            <div class="row">
                                <div class="col-md-12 mb-4">
                                    <div class="alert alert-warning border-0 bg-warning bg-opacity-10 text-dark">
                                        <i class="bi bi-info-circle-fill me-2"></i>
                                        Para validar sua inscri√ß√£o, √© necess√°rio anexar o comprovativo de pagamento ou usar uma refer√™ncia.
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">M√©todo de Pagamento *</label>
                                    <select name="metodo_pagamento" id="id_metodo_pagamento" class="form-select" required>
                                        <option value="multicaixa">Multicaixa (Transfer√™ncia/Dep√≥sito)</option>
                                        <option value="referencia">Refer√™ncia Banc√°ria (PREPARA√á√ÉO)</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3" id="div_numero_comprovante">
                                    <label class="form-label">N√∫mero do Comprovante *</label>
                                    <input type="text" name="numero_comprovante" class="form-control" placeholder="Digite o n¬∫ do comprovativo">
                                </div>
                                <div class="col-md-12 mb-3" id="div_comprovativo_file">
                                    <label class="form-label">Anexar Comprovativo (PDF/Imagem) *</label>
                                    <input type="file" name="comprovativo_pagamento" class="form-control" accept="image/*,.pdf">
                                </div>
                                <div class="col-md-12 mb-3 d-none" id="div_referencia_info">
                                    <div class="p-3 bg-light border rounded">
                                        <p class="mb-1"><strong>Entidade:</strong> 00000</p>
                                        <p class="mb-1"><strong>Refer√™ncia:</strong> <span class="text-primary fw-bold" id="ref_gerada">---</span></p>
                                        <p class="mb-0 small text-muted">A refer√™ncia ser√° validada automaticamente ap√≥s o pagamento.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <h5 class="mt-4 mb-3"><i class="bi bi-gear me-2"></i>Configura√ß√µes Finais</h5>
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" name="receber_emails_sistema" id="id_receber_emails_sistema" {% if form_data.receber_emails_sistema %}checked{% endif %}>
                                        <label class="form-check-label" for="id_receber_emails_sistema">Deseja receber emails do sistema?</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" id="btn_prev">
                                <i class="bi bi-arrow-left me-2"></i>Anterior
                            </button>
                            <button type="button" class="btn btn-custom" id="btn_next">
                                Pr√≥ximo<i class="bi bi-arrow-right ms-2"></i>
                            </button>
                            <button type="submit" class="btn btn-success d-none" id="btn_submit">
                                <i class="bi bi-check-circle me-2"></i>Confirmar Inscri√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .bg-custom { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); }
    .progress-wizard { display: flex; justify-content: space-between; position: relative; }
    .progress-wizard::before { content: ''; position: absolute; top: 25px; left: 12.5%; right: 12.5%; height: 3px; background: #e0e0e0; z-index: 0; }
    .wizard-step { flex: 1; text-align: center; position: relative; z-index: 1; }
    .wizard-icon { width: 50px; height: 50px; border-radius: 50%; background: #e0e0e0; color: #666; display: inline-flex; align-items: center; justify-content: center; font-size: 1.3rem; margin-bottom: 8px; transition: all 0.3s; }
    .wizard-step.active .wizard-icon { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); color: white; transform: scale(1.1); }
    .wizard-step.completed .wizard-icon { background: #059669; color: white; }
    .wizard-label { font-size: 0.9rem; color: #666; font-weight: 500; }
    .wizard-step.active .wizard-label { color: #1e3a8a; font-weight: 600; }
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    .btn-custom { background: linear-gradient(135deg, #1e3a8a 0%, #059669 100%); border: none; color: white; }
    .btn-custom:hover { background: linear-gradient(135deg, #1e40af 0%, #10b981 100%); color: white; }
</style>

<script>
const localidadeDB = {
    'Angolana': {
        'Bengo': ['Ambriz', 'Bula Atumba', 'Dande', 'Dembos', 'Nambuangongo', 'Pango Aluqu√©m'],
        'Benguela': ['Balombo', 'Ba√≠a Farta', 'Benguela', 'Bocoio', 'Caimbambo', 'Catumbela', 'Chongor√≥i', 'Ganda', 'Lobito'],
        'Bi√©': ['Andulo', 'Camacupa', 'Catabola', 'Chinguar', 'Chitembo', 'Cuemba', 'Cunhinga', 'Cu√≠to', 'Nharea'],
        'Cabinda': ['Belize', 'Buco-Zau', 'Cabinda', 'Cacongo'],
        'Cuando Cubango': ['Calai', 'Cuangar', 'Cuchi', 'Cuito Cuanavale', 'Dirico', 'Mavinga', 'Menongue', 'Nancova', 'Rivungo'],
        'Cuanza Norte': ['Ambaca', 'Banguela', 'Bolongongo', 'Cambambe', 'Cazengo', 'Golungo Alto', 'Gonguembo', 'Lucala', 'Quiculungo', 'Samba Caju'],
        'Cuanza Sul': ['Amboim', 'Cassongue', 'Cela', 'Conda', 'Ebo', 'Libolo', 'Mussende', 'Porto Amboim', 'Quibala', 'Quilenda', 'Seles', 'Sumbe'],
        'Cunene': ['Cahama', 'Cuanhama', 'Curoca', 'Cuvelai', 'Namacunde', 'Ombadja'],
        'Huambo': ['Bailundo', 'Ca√°la', 'Catchiungo', 'Chicala-Cholohanga', 'Chinjenje', 'Ecunha', 'Huambo', 'Londuimbali', 'Longonjo', 'Mungo', 'Ucuma'],
        'Hu√≠la': ['Caconda', 'Cacula', 'Caluquembe', 'Chiange', 'Chibia', 'Chicomba', 'Chipindo', 'Cuvango', 'Humpata', 'Jamba', 'Lubango', 'Matala', 'Quilengues', 'Quipungo'],
        'Luanda': ['Belas', 'Cacuaco', 'Cazenga', 'Icolo e Bengo', 'Luanda', 'Qui√ßama', 'Kilamba Kiaxi', 'Talatona', 'Viana'],
        'Lunda Norte': ['Cambulo', 'Capenda-Camulemba', 'Caungula', 'Chitato', 'Cuilo', 'Cuango', 'Lubalo', 'Lucapa', 'X√°-Muteba'],
        'Lunda Sul': ['Cacolo', 'Dala', 'Muconda', 'Saurimo'],
        'Malanje': ['Cacuso', 'Calandula', 'Cambundi-Catembo', 'Cangandala', 'Caombo', 'Cuaba Nzogo', 'Cunda-dia-Baze', 'Luquembo', 'Malanje', 'Marimba', 'Massango', 'Mucari', 'Quela', 'Quirima'],
        'Moxico': ['Alto Zambeze', 'Bundas', 'Camanongue', 'L√©ua', 'Luau', 'Luacano', 'Luchazes', 'Cameia', 'Moxico'],
        'Namibe': ['Bibala', 'Camucuio', 'Mo√ß√¢medes', 'T√¥mbua', 'Virei'],
        'U√≠ge': ['Alto Cauale', 'Ambu√≠la', 'Bembe', 'Buengas', 'Bungo', 'Damba', 'Milunga', 'Mucaba', 'Negage', 'Puri', 'Quimbele', 'Quitexe', 'Sanza Pombo', 'Songo', 'U√≠ge', 'Zombo'],
        'Zaire': ['Cuimba', 'Mabanza Congo', 'Noqui', 'Nezeto', 'Soy', 'Tomboco']
    },
    'Portugal': {
        'Lisboa': ['Lisboa', 'Sintra', 'Cascais'],
        'Porto': ['Porto', 'Gaia', 'Maia']
    },
    'Brasil': {
        'S√£o Paulo': ['S√£o Paulo', 'Campinas', 'Santos'],
        'Rio de Janeiro': ['Rio de Janeiro', 'Niter√≥i']
    }
};

document.addEventListener('DOMContentLoaded', () => {
    const nSel = document.getElementById('id_nacionalidade');
    const pSel = document.getElementById('provincia_nascimento_select');
    const mSel = document.getElementById('municipio_nascimento_select');
    const pMan = document.getElementById('provincia_nascimento_manual');
    const mMan = document.getElementById('municipio_nascimento_manual');
    
    const divPSel = document.getElementById('div_provincia_select');
    const divMSel = document.getElementById('div_municipio_select');
    const divPMan = document.getElementById('div_provincia_manual');
    const divMMan = document.getElementById('div_municipio_manual');
    
    const fProv = document.getElementById('id_provincia_nascimento_final');
    const fMun = document.getElementById('id_local_nascimento_final');

    function sincronizar() {
        const nac = nSel.value;
        if (localidadeDB[nac]) {
            fProv.value = pSel.value;
            fMun.value = mSel.value;
        } else {
            fProv.value = pMan.value;
            fMun.value = mMan.value;
        }
    }

    function atualizarMunicipios() {
        const nac = nSel.value;
        const prov = pSel.value;
        mSel.innerHTML = '<option value="">Selecione o munic√≠pio...</option>';
        if (prov && localidadeDB[nac] && localidadeDB[nac][prov]) {
            localidadeDB[nac][prov].forEach(m => {
                const opt = new Option(m, m);
                mSel.add(opt);
            });
        }
        sincronizar();
    }

    function alternarNacionalidade() {
        const nac = nSel.value;
        const isMapeado = localidadeDB.hasOwnProperty(nac);
        
        divPSel.classList.toggle('d-none', !isMapeado);
        divMSel.classList.toggle('d-none', !isMapeado);
        divPMan.classList.toggle('d-none', isMapeado);
        divMMan.classList.toggle('d-none', isMapeado);
        
        if (isMapeado) {
            pSel.innerHTML = '<option value="">Selecione a prov√≠ncia...</option>';
            mSel.innerHTML = '<option value="">Selecione o munic√≠pio...</option>';
            Object.keys(localidadeDB[nac]).forEach(p => {
                const opt = new Option(p, p);
                pSel.add(opt);
            });
            pSel.required = true;
            mSel.required = true;
            pMan.required = false;
            mMan.required = false;
        } else {
            pSel.required = false;
            mSel.required = false;
            pMan.required = false;
            mMan.required = false;
        }
        sincronizar();
    }

    nSel.addEventListener('change', alternarNacionalidade);
    pSel.addEventListener('change', atualizarMunicipios);
    mSel.addEventListener('change', sincronizar);
    pMan.addEventListener('input', sincronizar);
    mMan.addEventListener('input', sincronizar);

    // Identifica√ß√£o Step Logic
    const nomeInput = document.getElementById('id_nome_completo_display');
    nomeInput.addEventListener('input', function() {
        const partes = this.value.trim().split(/\s+/);
        if (partes.length >= 1) {
            document.getElementById('id_primeiro_nome').value = partes[0];
            if (partes.length > 2) {
                document.getElementById('id_apelido').value = partes[partes.length - 1];
                document.getElementById('id_nomes_meio').value = partes.slice(1, -1).join(' ');
            } else if (partes.length === 2) {
                document.getElementById('id_apelido').value = partes[1];
                document.getElementById('id_nomes_meio').value = '';
            }
        }
    });

    // Foto e Webcam logic (simplified for speed)
    const btnWebcam = document.getElementById('btn_webcam');
    const fileInput = document.getElementById('id_foto');
    const video = document.getElementById('webcam_video');
    const photoPreview = document.getElementById('photo_preview');
    let stream = null;

    fileInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                photoPreview.style.backgroundImage = `url(${e.target.result})`;
                photoPreview.style.backgroundSize = 'cover';
                photoPreview.style.backgroundPosition = 'center';
                document.getElementById('placeholder_icon').style.display = 'none';
                video.style.display = 'none';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    btnWebcam.addEventListener('click', async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            video.style.display = 'block';
            document.getElementById('placeholder_icon').style.display = 'none';
            btnWebcam.classList.add('d-none');
            document.getElementById('btn_capture').classList.remove('d-none');
        } catch (e) { alert("Webcam error"); }
    });

    document.getElementById('btn_capture').addEventListener('click', () => {
        const canvas = document.getElementById('photo_canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        const data = canvas.toDataURL('image/jpeg');
        photoPreview.style.backgroundImage = `url(${data})`;
        photoPreview.style.backgroundSize = 'cover';
        document.getElementById('id_foto_base64').value = data;
        if (stream) stream.getTracks().forEach(t => t.stop());
        video.style.display = 'none';
        document.getElementById('btn_capture').classList.add('d-none');
        btnWebcam.classList.remove('d-none');
    });

    // Wizard Logic
    let currentStep = {{ current_step|default:1 }};
    const btnNext = document.getElementById('btn_next');
    const btnPrev = document.getElementById('btn_prev');
    const btnSubmit = document.getElementById('btn_submit');

    function updateWizard() {
        document.querySelectorAll('.form-step').forEach(s => s.classList.toggle('active', s.dataset.step == currentStep));
        document.querySelectorAll('.wizard-step').forEach(s => {
            s.classList.toggle('active', s.dataset.step == currentStep);
            s.classList.toggle('completed', s.dataset.step < currentStep);
        });

        // Atualizar Barra de Progresso Din√¢mica
        const progressPercent = (currentStep / 5) * 100;
        document.getElementById('wizard_progress_bar').style.width = progressPercent + '%';

        btnPrev.style.visibility = currentStep === 1 ? 'hidden' : 'visible';
        btnNext.classList.toggle('d-none', currentStep === 5);
        btnSubmit.classList.toggle('d-none', currentStep !== 5);
    }

    // Inicializar o wizard no passo correto
    updateWizard();

    btnNext.addEventListener('click', async () => {
        const stepEl = document.querySelector(`.form-step[data-step="${currentStep}"]`);
        let valid = true;
        
        // Limpar mensagens de erro anteriores
        stepEl.querySelectorAll('.invalid-feedback.ajax-error').forEach(e => e.remove());
        stepEl.querySelectorAll('.is-invalid').forEach(i => i.classList.remove('is-invalid'));

        stepEl.querySelectorAll('[required]').forEach(i => {
            if (!i.value.trim()) { i.classList.add('is-invalid'); valid = false; }
        });

        if (!valid) return;

        // Valida√ß√£o de Duplicidade (Lado do Cliente)
        if (currentStep === 1) {
            const biInput = document.getElementById('bilhete_identidade');
            if (biInput && biInput.value) {
                try {
                    const response = await fetch(`/api/verificar-existente/?q=${biInput.value}&campo=bilhete_identidade`);
                    const data = await response.json();
                    if (data.encontrado) {
                        biInput.classList.add('is-invalid');
                        const error = document.createElement('div');
                        error.className = 'invalid-feedback ajax-error';
                        error.textContent = 'Este BI j√° est√° registrado no sistema.';
                        biInput.after(error);
                        valid = false;
                    }
                } catch (e) { console.error("Erro na valida√ß√£o de BI"); }
            }
            
            // Valida√ß√£o de BI vencido
            const dataValidade = document.getElementById('id_data_validade_bi').value;
            if (dataValidade && valid) {
                const validade = new Date(dataValidade);
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                if (validade < hoje) {
                    const modalHtml = `
                        <div class="modal fade" id="biVencidoModal" data-bs-backdrop="static" tabindex="-1">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content border-0 shadow-lg">
                                    <div class="modal-header bg-danger text-white border-0 py-3">
                                        <h5 class="modal-title d-flex align-items-center">
                                            <i class="bi bi-shield-exclamation me-2 fs-4"></i>
                                            Documento Vencido
                                        </h5>
                                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body text-center p-4">
                                        <div class="mb-3">
                                            <i class="bi bi-exclamation-octagon-fill text-danger" style="font-size: 3.5rem;"></i>
                                        </div>
                                        <p class="text-muted mb-0">
                                            O seu Bilhete de Identidade est√° vencido. Por favor, dirija-se ao posto de identifica√ß√£o para proceder com a renova√ß√£o antes de continuar.
                                        </p>
                                    </div>
                                    <div class="modal-footer border-0 p-3 justify-content-center">
                                        <button type="button" class="btn btn-secondary px-5" data-bs-dismiss="modal">Fechar</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    const modal = new bootstrap.Modal(document.getElementById('biVencidoModal'));
                    modal.show();
                    document.getElementById('biVencidoModal').addEventListener('hidden.bs.modal', function () {
                        this.remove();
                    });
                    valid = false;
                }
            }
        }

        if (currentStep === 2 && valid) {
            const emailInput = document.getElementsByName('email_recuperacao')[0];
            if (emailInput && emailInput.value) {
                try {
                    const response = await fetch(`/api/verificar-username/?q=${emailInput.value}`);
                    const data = await response.json();
                    if (!data.disponivel) {
                        emailInput.classList.add('is-invalid');
                        const error = document.createElement('div');
                        error.className = 'invalid-feedback ajax-error';
                        error.textContent = 'Este e-mail j√° possui uma conta no sistema.';
                        emailInput.after(error);
                        valid = false;
                    }
                } catch (e) { console.error("Erro na valida√ß√£o de e-mail"); }
            }
            if (valid) {
                document.getElementById('id_username').value = emailInput.value;
            }
        }

        if (currentStep === 3 && valid) {
            // Gerar senha autom√°tica: Apelido + Ano de Nascimento
            const apelido = document.getElementById('id_apelido').value || 'estudante';
            const dataNascimento = document.getElementById('data_nascimento').value;
            let anoInvertido = '0000';
            if (dataNascimento) {
                const ano = dataNascimento.split('-')[0];
                anoInvertido = ano.split('').reverse().join('');
            }
            const autoPass = apelido.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '') + anoInvertido;
            document.getElementById('id_password_display').value = autoPass;
            document.getElementById('id_password').value = autoPass;
        }

        if (valid && currentStep < 5) { currentStep++; updateWizard(); }
    });

    const metodoPagamento = document.getElementById('id_metodo_pagamento');
    const divNumeroComprovante = document.getElementById('div_numero_comprovante');
    const divComprovativoFile = document.getElementById('div_comprovativo_file');
    const divReferenciaInfo = document.getElementById('div_referencia_info');
    const refGerada = document.getElementById('ref_gerada');

    if (metodoPagamento) {
        metodoPagamento.addEventListener('change', function() {
            if (this.value === 'referencia') {
                divNumeroComprovante.classList.add('d-none');
                divComprovativoFile.classList.add('d-none');
                divReferenciaInfo.classList.remove('d-none');
                const docNum = document.getElementById('bilhete_identidade').value || '000000';
                refGerada.innerText = '999' + docNum.substring(0, 6).replace(/\D/g, '') + '001';
            } else {
                divNumeroComprovante.classList.remove('d-none');
                divComprovativoFile.classList.remove('d-none');
                divReferenciaInfo.classList.add('d-none');
            }
        });
    }

    btnPrev.addEventListener('click', () => { if (currentStep > 1) { currentStep--; updateWizard(); } });

    alternarNacionalidade();
});
</script>
{% endblock %}